<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.30">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="坂本航太">

<title>SASマクロ入門1 – Kota Sakamoto</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-9849038e97c5862c14c4eb81893d019b.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-945f87a38397f0f3b8ef34e2f394b6bc.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "一致なし",
    "search-matching-documents-text": "一致した文書",
    "search-copy-link-title": "検索へのリンクをコピー",
    "search-hide-matches-text": "追加の検索結果を非表示",
    "search-more-match-text": "追加の検索結果",
    "search-more-matches-text": "追加の検索結果",
    "search-clear-button-title": "消去",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "取消",
    "search-submit-button-title": "検索",
    "search-label": "サーチ"
  }
}</script>


<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Kota Sakamoto</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="サーチ"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="ナビゲーションを切り替える" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../posts/statistics/index.html"> 
<span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../posts/Web_tools/Web_tools.html"> 
<span class="menu-text">Web Tools</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/kkts1010/kkts1010.github.io/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-left">
      <h1 class="title">SASマクロ入門1</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">SAS</div>
                <div class="quarto-category">解析プログラミング</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta column-page-left">

      <div>
      <div class="quarto-title-meta-heading">作者</div>
      <div class="quarto-title-meta-contents">
               <p>坂本航太 </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">公開</div>
      <div class="quarto-title-meta-contents">
        <p class="date">2025年6月14日</p>
      </div>
    </div>
    
      <div>
      <div class="quarto-title-meta-heading">更新日</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">2025年6月14日</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目次</h2>
   
  <ul class="collapse">
  <li><a href="#sasマクロ入門1" id="toc-sasマクロ入門1" class="nav-link active" data-scroll-target="#sasマクロ入門1"><span class="header-section-number">1</span> SASマクロ入門1</a>
  <ul class="collapse">
  <li><a href="#参考ブログ" id="toc-参考ブログ" class="nav-link" data-scroll-target="#参考ブログ"><span class="header-section-number">1.1</span> 参考ブログ</a></li>
  </ul></li>
  <li><a href="#マクロとは" id="toc-マクロとは" class="nav-link" data-scroll-target="#マクロとは"><span class="header-section-number">2</span> マクロとは</a>
  <ul class="collapse">
  <li><a href="#マクロはsasにプログラムを書いてもらうための機能" id="toc-マクロはsasにプログラムを書いてもらうための機能" class="nav-link" data-scroll-target="#マクロはsasにプログラムを書いてもらうための機能"><span class="header-section-number">2.1</span> マクロはSASにプログラムを書いてもらうための機能</a></li>
  <li><a href="#マクロの仕組み" id="toc-マクロの仕組み" class="nav-link" data-scroll-target="#マクロの仕組み"><span class="header-section-number">2.2</span> マクロの仕組み</a></li>
  <li><a href="#マクロ変数を使う" id="toc-マクロ変数を使う" class="nav-link" data-scroll-target="#マクロ変数を使う"><span class="header-section-number">2.3</span> マクロ変数を使う</a></li>
  <li><a href="#マクロプログラムを使う" id="toc-マクロプログラムを使う" class="nav-link" data-scroll-target="#マクロプログラムを使う"><span class="header-section-number">2.4</span> マクロプログラムを使う</a></li>
  <li><a href="#マクロをデバッグする" id="toc-マクロをデバッグする" class="nav-link" data-scroll-target="#マクロをデバッグする"><span class="header-section-number">2.5</span> 5. マクロをデバッグする</a></li>
  <li><a href="#マクロをライブラリとして整理して活用する" id="toc-マクロをライブラリとして整理して活用する" class="nav-link" data-scroll-target="#マクロをライブラリとして整理して活用する"><span class="header-section-number">2.6</span> 6. マクロをライブラリとして整理して活用する</a></li>
  <li><a href="#マクロのコツ" id="toc-マクロのコツ" class="nav-link" data-scroll-target="#マクロのコツ"><span class="header-section-number">2.7</span> マクロのコツ</a></li>
  <li><a href="#マクロの実例" id="toc-マクロの実例" class="nav-link" data-scroll-target="#マクロの実例"><span class="header-section-number">2.8</span> マクロの実例</a></li>
  <li><a href="#終わりに" id="toc-終わりに" class="nav-link" data-scroll-target="#終わりに"><span class="header-section-number">2.9</span> 終わりに</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block column-page-left" id="quarto-document-content">





<section id="sasマクロ入門1" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> SASマクロ入門1</h1>
<p>本記事では、2022年SASユーザー総会の森田氏の「マクロのすすめ～SASにプログラムをかいてもらおう～」の文章を写経したものである。個人の勉強記録であるため、基本的には元の資料を参考にしていただきたい。</p>
<section id="参考ブログ" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="参考ブログ"><span class="header-section-number">1.1</span> 参考ブログ</h2>
<p>基礎的な事項で参考になるものはいつも通り、以下のブログである。特に実務上で重要だが知られていないデータステップで変数をマクロ化する<code>call syputx</code>、データステップ外で関数を使えるようにする<code>%sysfunc</code>はきちんと理解したい。また、<code>マクロ言語入門9</code>で紹介されている&amp;macro_variable.の<code>.</code>は常に記載する、もしくは記載しない等を組織/個人開発で統一しておくことが望ましい。</p>
<ul>
<li><a href="https://sas-boubi.blogspot.com/2016/05/macro-let.html">マクロ言語入門1：マクロ変数とは【%LET】</a></li>
<li><a href="https://sas-boubi.blogspot.com/2016/05/2macromend.html">マクロ言語入門2：マクロの登録と実行【%MACRO、%MEND】</a></li>
<li><a href="https://sas-boubi.blogspot.com/2016/05/3.html">マクロ言語入門3：パラメータの設定【定位置パラメータ】</a></li>
<li><a href="https://sas-boubi.blogspot.com/2016/05/4.html">マクロ言語入門4：パラメータの設定【キーワードパラメータ】</a></li>
<li><a href="https://sas-boubi.blogspot.com/2016/05/5strbquote.html">マクロ言語入門5：クォート処理【%STR関数】</a></li>
<li><a href="https://sas-boubi.blogspot.com/2016/05/6bquote.html">マクロ言語入門6：クォート処理【%BQUOTE関数】</a></li>
<li><a href="https://sas-boubi.blogspot.com/2016/06/macro-do.html">マクロ言語入門7：マクロ内でのループ処理【%DO】</a></li>
<li><a href="https://sas-boubi.blogspot.com/2016/07/8if.html">マクロ言語入門8：マクロ内での条件分岐処理【%IF】</a></li>
<li><a href="https://sas-boubi.blogspot.com/2016/07/9.html">マクロ言語入門9：マクロ変数とドット</a></li>
<li><a href="https://sas-boubi.blogspot.com/2016/07/10.html">マクロ言語入門10：マクロ変数と&amp;&amp;</a></li>
<li><a href="https://sas-boubi.blogspot.com/2016/08/11-evalsysevalf.html">マクロ言語入門11：演算評価 【%EVAL、%SYSEVALF】</a></li>
<li><a href="https://sas-boubi.blogspot.com/2014/07/call-symputx1.html">値をマクロ変数に格納する「CALL SYMPUTX」その1</a></li>
<li><a href="https://sas-boubi.blogspot.com/2015/09/sysfunc.html">データステップ外で関数を使えるようにする「%SYSFUNC」その１</a></li>
<li>森岡 裕, %if-%then-%doのオープンコードでの利用と9.4以降のSASマクロ拡張点について, SASユーザー総会論文集, 2021.</li>
<li>本本 早紀, クォート処理及びスコープへの理解を深める, SASユーザー総会論文集, 2019, p141-150</li>
<li>竹田 真, 佐藤 智美, 社内マクロライブラリの構築について, SASユーザー総会論文集, 2001, p37-44</li>
<li>柳沢 健太郎, 常吉 華奈, 山本 典子, 臨床試験における集計解析用 SASプログラムの標準化, SASユーザー総会論文集, 2004, p37-44</li>
<li>田村 洋介, SASマクロライブラリの開発/管理/運用, SASユーザー総会論文集, 2007, p123-134</li>
<li>“How to organize your SAS projects in Git”, SAS Blogs, 2020-11-10</li>
<li>“Good Programming Practice In Macro Development”, PhUSE Advance Hub, 2021-09-21</li>
<li>Ron Cody, Cody’s Data Cleaning Techniques Using SAS, SAS Press, 2017, 234p</li>
<li>市橋 里絵, 江口 幸子, 渡邊 大丞, 月田 あづき, “Standard Template Programs”の開発, SASユーザー総会論文集, 2010, p381-383</li>
</ul>
<p>また、他にも応用上の使い方等は以下が参考になる。 - <a href="https://sas-tumesas.blogspot.com/2016/10/compare.html">Compareプロシジャの結果が一致か不一致か、何が不一致かをマクロ変数で取得する話</a> なお、私が知る限り<code>Proc Compare Procedure</code>の解説文献は、2022年度のSASユーザー総会資料の<code>COMPAREプロシジャの便利な使い方</code>がおすすめである。<code>Proc Compare Procedure</code>については別記事で解説する。</p>
</section>
</section>
<section id="マクロとは" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> マクロとは</h1>
<p>本章では、マクロ機能とその仕組みを概説する。また、マクロ習得のメリットがデメリットを上回ることを述べる。</p>
<section id="マクロはsasにプログラムを書いてもらうための機能" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="マクロはsasにプログラムを書いてもらうための機能"><span class="header-section-number">2.1</span> マクロはSASにプログラムを書いてもらうための機能</h2>
<p>マクロは、簡単に言うとテキストの置換機能である。Aという文字列をBという文字列に置き換える機能である。そして、このテキスト置換機能がたいへん役に立つ。なぜなら、プログラミング業務では、似たような解析やデータハンドリングを繰り返し行っている場合が多いからである。例えば、他のプロジェクトと同じ解析を行う、対象のデータセット名だけが異なる、対象データの抽出条件だけが異なる、処理対象の変数だけが異なる、設定値やオプション指定だけが異なる、出力形式（行数や列数、ファイル形式など）だけが異なる。こういった場合、各解析のSASプログラムの大部分が重複することになり、差異が生じるのは、ほんの一部となる。つまり、基準となるプログラムをコピー&amp;ペーストで複製して、変更が必要な箇所だけをテキスト置換すれば済む場合が多い。この基準となるプログラムの設定とテキスト置換をSASプログラムで実現するための機能がマクロである。マクロがプログラムを書いてくれるのである。</p>
</section>
<section id="マクロの仕組み" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="マクロの仕組み"><span class="header-section-number">2.2</span> マクロの仕組み</h2>
<p>私たちの書いたSASプログラムは、SASのコンパイラによって解釈され、実行される。このとき、実はSASには二種類のコンパイラがある。</p>
<p>1. マクロを解析・実行するマクロプロセッサ、</p>
<p>2. DATAステップおよびPROCステップを解析・実行するコンパイラである。</p>
<p>SASプログラムをサブミットすると、まず、①マクロプロセッサがマクロ部分だけを解析・実行し、DATAステップまたはPROCステップの命令だけのプログラムを作成する。その後、②のコンパイラによって、マクロ部分が解析された後のプログラムを実行する。</p>
</section>
<section id="マクロ変数を使う" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="マクロ変数を使う"><span class="header-section-number">2.3</span> マクロ変数を使う</h2>
<p>本章では、マクロの基本的な機能であるマクロ変数について概説する。シンプルな機能ながら応用場面は多い。マクロ変数を習得するだけでもプログラミングの効率化や品質向上が期待できる。</p>
<section id="マクロ変数とは" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1" class="anchored" data-anchor-id="マクロ変数とは"><span class="header-section-number">2.3.1</span> マクロ変数とは</h3>
<p>マクロ変数はテキストを格納する容れものである。マクロ変数に格納したテキストはプログラム中で参照できる。マクロプロセッサは、SASプログラム内でマクロ変数の参照箇所を見つけると、そのマクロ変数に格納したテキストに置き換える。テキストファイルで行う一括置換をSASに実行してもらうイメージである。</p>
</section>
<section id="マクロ変数の作成と参照" class="level3" data-number="2.3.2">
<h3 data-number="2.3.2" class="anchored" data-anchor-id="マクロ変数の作成と参照"><span class="header-section-number">2.3.2</span> マクロ変数の作成と参照</h3>
<p>マクロ変数は%letステートメントを利用して作成する。</p>
<p>%let マクロ変数名 = 格納したい値;</p>
<p>マクロ変数名は最大32文字、最初の文字は英字またはアンダースコア、その後の文字は英字・数字・アンダースコアが使用可能である。また大文字と小文字は区別されない。設定値AF、DMS、SQL、SYSは該当する自動マクロ変数と名前が重複する可能性があるため、避けたほうがよい。</p>
<div class="sourceCode" id="cb1" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb1-1"><a href="#cb1-1"></a>%let greeting = Hello World;</span>
<span id="cb1-2"><a href="#cb1-2"></a>%put &amp;greeting.;</span>
<span id="cb1-3"><a href="#cb1-3"></a>%put 「Hello World」と表示;</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a>%let year = 40;</span>
<span id="cb1-6"><a href="#cb1-6"></a>%let comment = おめでとうございます;</span>
<span id="cb1-7"><a href="#cb1-7"></a>%put SASユーザー総会&amp;year.周年&amp;comment.;</span>
<span id="cb1-8"><a href="#cb1-8"></a>%put 「SASユーザー総会40周年おめでとうございます」と表示;</span>
<span id="cb1-9"><a href="#cb1-9"></a></span>
<span id="cb1-10"><a href="#cb1-10"></a>%let anavar = age; /* マクロ変数&amp;anavarを定義し、ageという値を格納 */</span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a>/* 単変量解析; */</span>
<span id="cb1-13"><a href="#cb1-13"></a>proc univariate data = sashelp.class;</span>
<span id="cb1-14"><a href="#cb1-14"></a>var &amp;anavar.; /* マクロプロセッサによって&amp;age.に置換される */</span>
<span id="cb1-15"><a href="#cb1-15"></a>class sex;</span>
<span id="cb1-16"><a href="#cb1-16"></a>run;</span>
<span id="cb1-17"><a href="#cb1-17"></a></span>
<span id="cb1-18"><a href="#cb1-18"></a>/* 単変量解析(bee-swarm plot)を作成; */</span>
<span id="cb1-19"><a href="#cb1-19"></a>proc sgplot data = sashelp.class;</span>
<span id="cb1-20"><a href="#cb1-20"></a>vbox &amp;anavar. / category = sex nofill nooutliers;</span>
<span id="cb1-21"><a href="#cb1-21"></a>scatter y = &amp;anavar. x = sex / jitter;</span>
<span id="cb1-22"><a href="#cb1-22"></a>run;</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>マクロ変数により、プログラムに一貫性を持たせることができる。例えば、追加解析や仕様変更により、年齢(age)ではなく体重(weight)の解析を行いたい場合は、%let anavarの定義部分だけを変更するだけで済む。人の手を介することで修正漏れやミスタイプのリスクがある。</p>
<p>また、CALL SYMPUTXルーチンを利用すれば、DATAステップでデータセットの変数の内容をマクロ変数に格納できる。次章で説明する制御構文と併せて、データセットの内容に応じて、プログラムを変更させることが可能になり、プログラムに柔軟性を与えられる。</p>
<div class="sourceCode" id="cb2" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb2-1"><a href="#cb2-1"></a>call symputx('マクロ変数名', 格納したい値(DATAステップの変数名));</span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a>/* 男女別の生徒数を数えて、それぞれをマクロ変数に格納する; */</span>
<span id="cb2-4"><a href="#cb2-4"></a>proc freq data = sashelp.class noprint;</span>
<span id="cb2-5"><a href="#cb2-5"></a>tables sex / out = out1;</span>
<span id="cb2-6"><a href="#cb2-6"></a>run;</span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a>data _null_;</span>
<span id="cb2-9"><a href="#cb2-9"></a>set out1;</span>
<span id="cb2-10"><a href="#cb2-10"></a>if sex = "男子" then call symputx('N_Male', count);</span>
<span id="cb2-11"><a href="#cb2-11"></a>if sex = "女子" then call symputx('N_Female', count);</span>
<span id="cb2-12"><a href="#cb2-12"></a>run;</span>
<span id="cb2-13"><a href="#cb2-13"></a></span>
<span id="cb2-14"><a href="#cb2-14"></a>/* マクロ変数の値をログに出力して確認; */</span>
<span id="cb2-15"><a href="#cb2-15"></a>%put N_Male = &amp;N_Male N_Female = &amp;N_Female;/* 「N_Male : 10 N_Female : 9」と出力; */</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>また、SQLプロシジャのINTO句を利用して、データセットの変数の内容をマクロ変数に格納することも可能である。</p>
<div class="sourceCode" id="cb3" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb3-1"><a href="#cb3-1"></a>proc sql;</span>
<span id="cb3-2"><a href="#cb3-2"></a>select 変数名1, 変数名2, ..., 変数名N</span>
<span id="cb3-3"><a href="#cb3-3"></a>into :マクロ変数名1, :マクロ変数名2, ..., :マクロ変数名N</span>
<span id="cb3-4"><a href="#cb3-4"></a>from データセット名;</span>
<span id="cb3-5"><a href="#cb3-5"></a>quit;</span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a>proc sql noprint;</span>
<span id="cb3-8"><a href="#cb3-8"></a>create table work.class as</span>
<span id="cb3-9"><a href="#cb3-9"></a>select *</span>
<span id="cb3-10"><a href="#cb3-10"></a>from sashelp.class</span>
<span id="cb3-11"><a href="#cb3-11"></a>run;</span>
<span id="cb3-12"><a href="#cb3-12"></a>quit;</span>
<span id="cb3-13"><a href="#cb3-13"></a></span>
<span id="cb3-14"><a href="#cb3-14"></a>%put &amp;sqlobs.; /* proc sqlで直近に処理したデータ(OBS数)を格納; */</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="マクロ変数は文字型変数" class="level3" data-number="2.3.3">
<h3 data-number="2.3.3" class="anchored" data-anchor-id="マクロ変数は文字型変数"><span class="header-section-number">2.3.3</span> マクロ変数は文字型変数</h3>
<p>マクロ変数は、DATAステップと違って、すべて文字型変数として扱われる。このため、マクロプロセッサに数値演算をさせるような場面では、注意が必要である。数値の場合は%eval関数、小数を含む場合は%sysevalf関数に演算式を渡す必要がある。（ただし、%evalと%sysevalfは、演算のおよそについても調査した上で利用しないと）</p>
<div class="sourceCode" id="cb4" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb4-1"><a href="#cb4-1"></a>%let not5 = 1 + 4;</span>
<span id="cb4-2"><a href="#cb4-2"></a>%put &amp;not5.; /* 「1 + 4」と表示; */</span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a>%let equal5 = %eval(1 + 4);</span>
<span id="cb4-5"><a href="#cb4-5"></a>%put &amp;equal5.; /* 「5」と表示; */</span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a>%let not5 = 1.5 + 3.5;</span>
<span id="cb4-8"><a href="#cb4-8"></a>%put &amp;not5.; /* 「1.5 + 3.5」と表示; */</span>
<span id="cb4-9"><a href="#cb4-9"></a></span>
<span id="cb4-10"><a href="#cb4-10"></a>%let equal5 = %sysevalf(1.5 + 3.5);</span>
<span id="cb4-11"><a href="#cb4-11"></a>%put &amp;equal5.; /* 「5」と表示; */</span>
<span id="cb4-12"><a href="#cb4-12"></a></span>
<span id="cb4-13"><a href="#cb4-13"></a>%let not5 = %eval(1.5 + 3.5); /* %evalは整数計算だけなのでエラーとなる */</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>なお、格納されるテキストによってマクロ変数の変数は自動的に調整されるため、データセットの文字型変数のように長さを気にする必要はない（ただし、SAS9.4の最大長は65,534文字である）。</p>
</section>
<section id="自動マクロ変数" class="level3" data-number="2.3.4">
<h3 data-number="2.3.4" class="anchored" data-anchor-id="自動マクロ変数"><span class="header-section-number">2.3.4</span> 自動マクロ変数</h3>
<p>マクロプロセッサが自動的に作成する自動マクロ変数もある。自動マクロ変数は、実行環境の確認、プログラム実行時の表示などに利用できる。いくつか例を示す。</p>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>自動マクロ変数名</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>SYSVER</td>
<td>SASのバージョンを格納（例：9.4）</td>
</tr>
<tr class="even">
<td>SYSDATEP</td>
<td>SAS セッションの開始日をDATEフォーマットで格納（例：01SEP2022）</td>
</tr>
<tr class="odd">
<td>SYSLAST</td>
<td>SAS セッションで直近に作成したデータセットを格納（例：WORK.CLASS）</td>
</tr>
<tr class="even">
<td>SYSUSERID</td>
<td>現在のSAS プロセスのユーザーIDを格納（例：morita.yusuke）</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="マクロプログラムを使う" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="マクロプログラムを使う"><span class="header-section-number">2.4</span> マクロプログラムを使う</h2>
<p>本章では、マクロの主要機能であるマクロプログラムについて概説する。前章のマクロ変数とマクロプログラムを組み合わせることで、より複雑なプログラムをマクロプロセッサに書いてもらうことができる。</p>
<section id="マクロプログラムとは" class="level3" data-number="2.4.1">
<h3 data-number="2.4.1" class="anchored" data-anchor-id="マクロプログラムとは"><span class="header-section-number">2.4.1</span> マクロプログラムとは</h3>
<p>マクロプログラムもマクロ変数と同様に、テキスト置換を行う機能である。マクロ変数は、プログラム中の変数名、データセット名、オプションまたは短いテキストの置換に用いられる場合が多い。一方、マクロプログラムは、あるまとまった単位のSAS プログラムへの置換に利用されるものであり、マクロ変数と組み合わせることで、また、制御構文を使用することで、さまざまなプログラムをマクロプロセッサに手軽に作成してもらうことができる。</p>
</section>
<section id="マクロプログラムの作成呼び出し方法" class="level3" data-number="2.4.2">
<h3 data-number="2.4.2" class="anchored" data-anchor-id="マクロプログラムの作成呼び出し方法"><span class="header-section-number">2.4.2</span> マクロプログラムの作成・呼び出し方法</h3>
<p>マクロプログラムは%macroおよび%mendステートメントを利用して作成する。</p>
<div class="sourceCode" id="cb5" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb5-1"><a href="#cb5-1"></a>%macro マクロプログラム名; （簡略したいテキスト） %mend マクロプログラム名;</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>マクロプログラム名は最大32文字、最初の文字は英字またはアンダースコア、その後の文字は英字・数字・アンダースコアが使用可能である。</p>
</section>
<section id="マクロプログラムの特徴" class="level3" data-number="2.4.3">
<h3 data-number="2.4.3" class="anchored" data-anchor-id="マクロプログラムの特徴"><span class="header-section-number">2.4.3</span> マクロプログラムの特徴</h3>
<section id="呼び出し時にマクロ変数を受け取ることができる" class="level4" data-number="2.4.3.1">
<h4 data-number="2.4.3.1" class="anchored" data-anchor-id="呼び出し時にマクロ変数を受け取ることができる"><span class="header-section-number">2.4.3.1</span> 呼び出し時にマクロ変数を受け取ることができる</h4>
<p>基準となるプログラムをコピー&amp;ペーストして、一部分を書き換えたい場合があ る。この基準となるプログラムをマクロプログラム内に格納して、書き換えたい箇所を呼び出し時に受け取れるマクロ変数として、マクロプログラムに指定できる。このマクロプログラム呼び出し時に受け取るマクロ変数をマクロパラメータという。マクロパラメータも、ユーザーが任意の名前を設定可能で、そのマクロプログラム内で参照可能なマクロ変数となる。マクロパラメータとしてデータセット名(dsn)および変数名(var)を指定する例を以下に示す。</p>
<div class="sourceCode" id="cb6" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb6-1"><a href="#cb6-1"></a>/* 呼び出し時にマクロパラメータを指定; */</span>
<span id="cb6-2"><a href="#cb6-2"></a>%macro univariate2(dsn, var); /* マクロ名の後にマクロパラメータを設定; */</span>
<span id="cb6-3"><a href="#cb6-3"></a></span>
<span id="cb6-4"><a href="#cb6-4"></a>proc univariate data = &amp;dsn.;</span>
<span id="cb6-5"><a href="#cb6-5"></a>var &amp;var.;</span>
<span id="cb6-6"><a href="#cb6-6"></a>class sex;</span>
<span id="cb6-7"><a href="#cb6-7"></a>run;</span>
<span id="cb6-8"><a href="#cb6-8"></a></span>
<span id="cb6-9"><a href="#cb6-9"></a>%mend;</span>
<span id="cb6-10"><a href="#cb6-10"></a></span>
<span id="cb6-11"><a href="#cb6-11"></a>/* 呼び出し時にマクロパラメータを指定して実行; */</span>
<span id="cb6-12"><a href="#cb6-12"></a>%univariate2(dsn=sashelp.class, var=age)</span>
<span id="cb6-13"><a href="#cb6-13"></a>%univariate2(dsn=sashelp.class, var=weight)</span>
<span id="cb6-14"><a href="#cb6-14"></a>%univariate2(dsn=sashelp.class, var=height)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>また、マクロパラメータに予め既定値を与えることもできる。この既定値をもつマクロパラメータをキーワードパラメータという。キーワードパラメータは呼び出し時に指定しなければ、既定値が自動的に設定される。したがって、ほぼ毎回同じパラメータで実行する可能性があるパラメータはキーワードパラメータとして宣言すとよい。</p>
</section>
<section id="制御構文が使える" class="level4" data-number="2.4.3.2">
<h4 data-number="2.4.3.2" class="anchored" data-anchor-id="制御構文が使える"><span class="header-section-number">2.4.3.2</span> 制御構文が使える</h4>
<p>DATAステップでは、条件分岐のIFステートメント、反復処理のDOステートメントが使用できる。マクロ言語にも同様に%ifステートメント、%doステートメントが用意されており、データセットの内容やマクロパラメータの内容に応じて、マクロプロセッサの動作を変更できる。これら制御構文はマクロ変数にはない機能で、マクロプログラムに柔軟性を与える機能の一つとなっている。</p>
<p>制御構文の例として、条件分岐の%ifステートメントについて説明する。</p>
<div class="sourceCode" id="cb7" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb7-1"><a href="#cb7-1"></a>%if 条件文 %then %do;</span>
<span id="cb7-2"><a href="#cb7-2"></a>(条件文がTrueの場合の処理)</span>
<span id="cb7-3"><a href="#cb7-3"></a>%end;</span>
<span id="cb7-4"><a href="#cb7-4"></a>%else %if 条件文 %then %do;</span>
<span id="cb7-5"><a href="#cb7-5"></a>(条件文がTrueの場合の処理)</span>
<span id="cb7-6"><a href="#cb7-6"></a>%end;</span>
<span id="cb7-7"><a href="#cb7-7"></a>%else %do;</span>
<span id="cb7-8"><a href="#cb7-8"></a>(全条件文をも不満足している場合の処理)</span>
<span id="cb7-9"><a href="#cb7-9"></a>%end;</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>なお、上記のdsn および var のように、既定値を持たないマクロパラメータを位置パラメータという。</p>
<p>また、DATAステップでは、条件分岐から反復処理の%doステートメントについて説明する。</p>
<div class="sourceCode" id="cb8" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb8-1"><a href="#cb8-1"></a>%macro list_by_4years(startyr, endyr);</span>
<span id="cb8-2"><a href="#cb8-2"></a>    title1 "Customer List of &amp;yr. to &amp;endyr.";</span>
<span id="cb8-3"><a href="#cb8-3"></a>    proc print data = work.customer;</span>
<span id="cb8-4"><a href="#cb8-4"></a>        where &amp;yr. &lt;= year &lt;= &amp;endyr., &amp;by 4;</span>
<span id="cb8-5"><a href="#cb8-5"></a>        var year customer_revenue;</span>
<span id="cb8-6"><a href="#cb8-6"></a>    run;</span>
<span id="cb8-7"><a href="#cb8-7"></a>    title1 "Customer List of 2000 to 2003";</span>
<span id="cb8-8"><a href="#cb8-8"></a>    proc print data = work.customer;</span>
<span id="cb8-9"><a href="#cb8-9"></a>        where 2000 &lt;= year &lt;= 2003;</span>
<span id="cb8-10"><a href="#cb8-10"></a>        var year customer_revenue;</span>
<span id="cb8-11"><a href="#cb8-11"></a>    run;</span>
<span id="cb8-12"><a href="#cb8-12"></a>    title1 "Customer List of 2004 to 2007";</span>
<span id="cb8-13"><a href="#cb8-13"></a>    proc print data = work.customer;</span>
<span id="cb8-14"><a href="#cb8-14"></a>        where 2004 &lt;= year &lt;= 2007;</span>
<span id="cb8-15"><a href="#cb8-15"></a>        var year customer_revenue;</span>
<span id="cb8-16"><a href="#cb8-16"></a>    run;</span>
<span id="cb8-17"><a href="#cb8-17"></a>%mend;</span>
<span id="cb8-18"><a href="#cb8-18"></a></span>
<span id="cb8-19"><a href="#cb8-19"></a>%list_by_4years(startyr=1996, endyr=2007)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>マクロの制御構文には、他にも%do-%while、%do-%until等がある。しかし、初心者のうちは%ifと%doの2つを事実としても余りがない。%ifと%doもマクロプロセッサに対する命令である。一方、DATAステップのコンパイラに対する命令であり、データセットの変数の内容を変更することになる。ただし、%ifと%do%sysevalfは、SAS9.4 M5からマクロプログラム内部でなくても（オープンコードで）%if%then%else等を使えるようになった。2021年のSASユーザー総会の発表資料に詳細が記載されている。</p>
</section>
</section>
<section id="マクロ関数" class="level3" data-number="2.4.4">
<h3 data-number="2.4.4" class="anchored" data-anchor-id="マクロ関数"><span class="header-section-number">2.4.4</span> マクロ関数</h3>
<p>字句SASで用意されたマクロ関数を利用できる。これらのマクロ関数は、マクロプロセッサによって実行されるマクロプログラムである。DATAステップでデータセットを編集するために利用される関数と同名・同機能であっても異なるものであることに留意されたい。以下にマクロ関数の一例を示す。</p>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>マクロ関数名</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>%upcase(文字列) / %lowcase(文字列)</td>
<td>文字列を大文字/小文字に変換する</td>
</tr>
<tr class="even">
<td>%trim(文字列)</td>
<td>文字列の末尾の余分なスペース文字を取り除く</td>
</tr>
<tr class="odd">
<td>%index(文字列1, 文字列2)</td>
<td>文字列1の中に文字列2が含まれていれば、最初の位置(何文字目)を返す。文字列2が含まれていなければ0を返す</td>
</tr>
<tr class="even">
<td>%sysfunc(関数名)</td>
<td>DATAステップの関数をマクロプロセッサから使用する</td>
</tr>
</tbody>
</table>
</section>
<section id="マクロ変数のスコープ" class="level3" data-number="2.4.5">
<h3 data-number="2.4.5" class="anchored" data-anchor-id="マクロ変数のスコープ"><span class="header-section-number">2.4.5</span> マクロ変数のスコープ</h3>
<p>マクロ変数にもスコープ、つまりプログラム中で参照可能な範囲がある。スコープによってglobal マクロ変数とlocal マクロ変数に区分される。global マクロ変数は、プログラムのどこからでも値を参照可能である。一方、local 変数は、その変数が宣言されたマクロプログラム内部でのみ値を参照可能である。</p>
<div class="sourceCode" id="cb9" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb9-1"><a href="#cb9-1"></a>/* マクロ変数のスコープ; */</span>
<span id="cb9-2"><a href="#cb9-2"></a>%global global_var; /* グローバルマクロ変数を宣言; */</span>
<span id="cb9-3"><a href="#cb9-3"></a></span>
<span id="cb9-4"><a href="#cb9-4"></a>%macro global_local;</span>
<span id="cb9-5"><a href="#cb9-5"></a>    %let local_var = ローカル変数です; /* このマクロ内部だけで有効期間; */</span>
<span id="cb9-6"><a href="#cb9-6"></a>    %let global_var = グローバル変数です;</span>
<span id="cb9-7"><a href="#cb9-7"></a>%mend;</span>
<span id="cb9-8"><a href="#cb9-8"></a></span>
<span id="cb9-9"><a href="#cb9-9"></a>%global_local /* マクロを実行; */</span>
<span id="cb9-10"><a href="#cb9-10"></a></span>
<span id="cb9-11"><a href="#cb9-11"></a>%put &amp;global_var.; /* グローバル変数なので、マクロ外でも参照可能; */</span>
<span id="cb9-12"><a href="#cb9-12"></a>%put &amp;local_var.; /* マクロ外なでマイナ一ルで、変数を参照できない; */</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>初心者のうちは、スコープを意識する機会はさほど無いかもしれない。しかし、チームでマクロプログラムを分担して構築する場合、マクロプログラムで構築されるシステムを利用する際は、マクロ変数の衝突を避けるため、マクロ変数のスコープに留意が必要となる。（local マクロ変数を明示的に作成するためのlocal ステートメントが用意されている。）</p>
</section>
</section>
<section id="マクロをデバッグする" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="マクロをデバッグする"><span class="header-section-number">2.5</span> 5. マクロをデバッグする</h2>
<p>本節で同じ章にまとめ」で、マクロを書けばバグが生じる。したがって、マクロを効率的にデバッグする技術を重要である。以下に、マクロプロセッサが、マクロプログラムを生じさせたのかを知ることが有用である。このため、マクロのデバッグを効率的に行うためのオプションが用意されている。以下に、よく使用するオプションの例を示す。</p>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>オプション名</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>MPRINT</td>
<td>マクロプロセッサによって生成されるSAS プログラムをSAS ログに表示する</td>
</tr>
<tr class="even">
<td>MLOGIC</td>
<td>マクロプロセッサがマクロパラメータにどのような値を受け取ったか、%if条件分岐を True/Falseのどちらに判断したか、マクロの開始点と終了点をSASログに表示する</td>
</tr>
<tr class="odd">
<td>SYMBOLGEN</td>
<td>マクロプロセッサが、マクロ変数をどの値に置き換えたかSAS ログに表示する</td>
</tr>
</tbody>
</table>
<p>これらのオプションを指定することで、SAS ログにマクロプロセッサからの情報が出力されるようになる。しかし、上記オプションを指定してもSAS ログを読み解くのが困難な場合もある。その場合、mfileオプションでマクロプロセッサが出力したプログラム全体を別ファイルとして出力することも可能である。（マクロの学習にも活用できる。）</p>
</section>
<section id="マクロをライブラリとして整理して活用する" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="マクロをライブラリとして整理して活用する"><span class="header-section-number">2.6</span> 6. マクロをライブラリとして整理して活用する</h2>
<p>作成したマクロは積極的に活用したほうがよい。一度制作したマクロプログラム、別の活用場面では思いがけずれなく再現全文が現在の場合がある。つまり、マクロはほとんど常設され、品質も向上していく。そこで本章では、作成したマクロプログラムをライブラリとして整理し、プログラムから呼び出し可能にする方法について説明する。</p>
<p>以下にマクロライブラリを作成する手順を示す。</p>
<ol type="1">
<li><p>マクロを格納するフォルダを用意する。（フォルダは複数あってもよい）</p></li>
<li><p>各マクロプログラムを個別ファイルに格納していうフォルダに保存する。 このとき、ファイル名はマクロ名と同じにする必要がある。（マクロ名.sas とする）</p></li>
<li><p>マクロを呼び出す側のプログラムで、以下のMAUTOSOURCE及びSASAUTOSの2つのオプションを指定する。このとき、SASAUTOSに（1）のフォルダを指定する。</p></li>
</ol>
<div class="sourceCode" id="cb10" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb10-1"><a href="#cb10-1"></a>/* マクロをライブラリとして活用する; */</span>
<span id="cb10-2"><a href="#cb10-2"></a>options mautosource sasautos=(sasautos, "C:\sasYearlyMacros");</span>
<span id="cb10-3"><a href="#cb10-3"></a>/* （1）の sasautos内容ないこと; */</span>
<span id="cb10-4"><a href="#cb10-4"></a>options mautosource sasautos=(sasautos, "C:\sasYearlyMacros" "C:\sasYearMacros");</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>これで、マクロライブラリ中のマクロプログラムが呼び出し可能になる。</p>
<p>また、本章では触れないが、継続として共有するライブラリを整備・活用した事例は、過去のSASユーザー総会の複数の発表がある。</p>
<p>また、SAS9.4 M6 以降、WebページのバージョンProgramming Tool であるGitHub との連携機能が搭載されている。GitHub上でマクロファイルのバージョン管理を行い、SASから直接GitHub上のマクロプログラムをinclude可能になっている。多くのオープンソースマクロがGitHub上で管理・公開されており、GitHub上での連携機能について今後の発展が注目される。</p>
</section>
<section id="マクロのコツ" class="level2" data-number="2.7">
<h2 data-number="2.7" class="anchored" data-anchor-id="マクロのコツ"><span class="header-section-number">2.7</span> マクロのコツ</h2>
<p>どんな項目もで正しく場合ほど拡張を発想する。本章ではマクロを作成する際に留意したいポイントを説明する。筆者にして筆者の経験に価値たけ書もあるかもしれない。PhUSE6が「Good Programming Practice In Macro Development」を公開しており、マクロ開発に関する考査ずべきポイントを学ぶことができる。なお、機械のコーディングルールやガイドラインがある場合には、それらを優先されたい。</p>
<section id="マクロでコードの重複を排除する" class="level3" data-number="2.7.1">
<h3 data-number="2.7.1" class="anchored" data-anchor-id="マクロでコードの重複を排除する"><span class="header-section-number">2.7.1</span> マクロでコードの重複を排除する</h3>
<p>マクロによりコードの重複部分を削減し、プログラム全体をコンパクトに保つのがポイントである。そのために、マクロ化する際には、どのようなポイントで構成するか、マクロのパラメータをどこに配置するかマクロ作成時の設計が大式である。しかし、このためには、一定の実装経験を積んで、マクロプロセッサに作成させたコードのイメージが持てるように下はないと無難い趣もある。まずはマクロを含まないプログラムを作成してから、重複部分をマクロ化していくというアプローチがある。いずれにせよコードの重複部分はマクロ化を考慮するポイントである。</p>
</section>
<section id="マクロの機能と入出力を明示する" class="level3" data-number="2.7.2">
<h3 data-number="2.7.2" class="anchored" data-anchor-id="マクロの機能と入出力を明示する"><span class="header-section-number">2.7.2</span> マクロの機能と入出力を明示する</h3>
<p>そのマクロプログラムが、どんな機能を提供するマクロか、出力は何か、入力は何かの3点を明示することは、便利でマクロを作成するうえで重要である。そのマクロプログラムのマクロパラメータとして明示する。そのマクロパラメータも馴染みやすいネーミングを心掛けたい。また、コメントも適切に活用して必要な情報を補記するべき利用を使用して説明する。以下に、データクリーニングの名前(Cody’s Data Cleaning Techniques Using SAS）に掲載されたもののマクロプログラムの冒頭部分である。</p>
</section>
<section id="マクロの機能と入出力を明示する-1" class="level3" data-number="2.7.3">
<h3 data-number="2.7.3" class="anchored" data-anchor-id="マクロの機能と入出力を明示する-1"><span class="header-section-number">2.7.3</span> マクロの機能と入出力を明示する</h3>
<p>そのマクロプログラムが、どんな機能を提供するマクロか、出力は何か、入力は何かの3点を明示することは、便利でマクロを作成するうえで重要である。そのマクロプログラムのマクロパラメータとして明示する。そのマクロパラメータも馴染みやすいネーミングを心掛けたい。また、コメントも適切に活用して必要な情報を補記するべき利用を使用して説明する。以下に、データクリーニングの名前(Cody’s Data Cleaning Techniques Using SAS）に掲載されたもののマクロプログラムの冒頭部分である。</p>
<div class="sourceCode" id="cb11" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb11-1"><a href="#cb11-1"></a>%macro auto_outliers(</span>
<span id="cb11-2"><a href="#cb11-2"></a>    Dsn=,       /* Data set name */</span>
<span id="cb11-3"><a href="#cb11-3"></a>    ID=,        /* Name of ID variable */ </span>
<span id="cb11-4"><a href="#cb11-4"></a>    Var_list=,  /* List of variables to check */</span>
<span id="cb11-5"><a href="#cb11-5"></a>    Trim=1,     /* Trim criterion */</span>
<span id="cb11-6"><a href="#cb11-6"></a>    N_sd=2      /* Number of standard deviations */</span>
<span id="cb11-7"><a href="#cb11-7"></a>);</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>コメントの細部もあるがAuto_Outliersマクロは外れ値を検出するマクロであることが読み取れる。入力として、対象データセット名(Dsn)、オブザベーションのID変数名(ID)、外れ値を抽出したい対象変数名(Var_list)、統計的な判断基準であるTrim_N_sd)を指定すればよいことがわかる。数章では、外れ値の統計基準やプログラムの詳細より、当初マクロプログラムからできることがわかる。したがって方がユーザーにより使いやすかっただいられる（Auto,はプログラム内部からできること）。</p>
</section>
<section id="マクロの内部をブラックボックス化し抽象化する" class="level3" data-number="2.7.4">
<h3 data-number="2.7.4" class="anchored" data-anchor-id="マクロの内部をブラックボックス化し抽象化する"><span class="header-section-number">2.7.4</span> マクロの内部をブラックボックス化し、抽象化する</h3>
<p>細部は基本原理は「プログラムの内部アルゴリズムを知らずとも、マクロプログラムの機能を利用可能にすること」である。これはプロシジャで用いるイメージに近い。例えば、私たちは SORT プロシジャに入力かのデータセット名とソート変数を指定すれば、プロシジャ内部のソートアルゴリズムを意識することなく目的を達成できる。このように、マクロプログラムを作成する際は、ユーザーにマクロの内部を意識させない形式をイメージすべきである。</p>
<p>やや哲学的な内容になるが、優れたマクロは、その出力だけを実行された課題が魅力を呈しない。マクロの内部にソート順を含めてカテゴリーゼットは変更しないようにする。また、マクロの内部だけで作成する一時的なデータセットを削除しなければ、ユーザーは、そのマクロ内部の構造する必要がないらならない。また、「文今後、新を適時」の結構で、マクロの終了時にマクロ内部で作成したworkデータセットを削除することもある。</p>
</section>
<section id="マクロプログラムはなるべくシンプルを保つ" class="level3" data-number="2.7.5">
<h3 data-number="2.7.5" class="anchored" data-anchor-id="マクロプログラムはなるべくシンプルを保つ"><span class="header-section-number">2.7.5</span> マクロプログラムはなるべくシンプルを保つ</h3>
<p>プログラム設計の原則に「分割して統治する」および「Keep it simple, stupid」があり、マクロプログラムもなるべくシンプルに保つことを推奨する。これは、マクロプログラムの汎用性を高めることと方針テンションスピ方向にあることも分かいている。また、新たにマクロプログラムを作成する際は、既存のマクロプログラムの入力方法を工夫すれば詳細なプロ先はせずとも済まない、あるいは既存のシンプルなマクロプログラムを利用して（呼び出して）作成できないか構想すべき場合がある。品質は既存されたシンプルのマクロプログラムを利用すれば、マクロプログラム全体のコードを予備し、かつ新たに作成するマクロプログラムの品質も維持しようといううがい対象である。</p>
</section>
<section id="コードの読みやすさや理解のしやすさにも配慮する" class="level3" data-number="2.7.6">
<h3 data-number="2.7.6" class="anchored" data-anchor-id="コードの読みやすさや理解のしやすさにも配慮する"><span class="header-section-number">2.7.6</span> コードの読みやすさや理解のしやすさにも配慮する</h3>
<p>マクロを書けば、いろいろな場面で活用できるようになるが、SASにプログラムを書いてもらうのが楽しくなり、%や&amp;が使いびう複雑なプログラムになる場合がある。もちろん、そのことは体はマクロを理解している範囲であり、マクロプロセッサも文法的に問題ないよう限りは説明に動いてくれる。一方で、保存する他のプログラマや求人の自分がプログラムを読み機会もあり、コードの読みやすさや理解のしやすさを保持して、あえてマクロ化しない（マクロ化しすぎない）という判断場合もある。</p>
<p>また、マクロプログラミングでも、DATAステップ同様にネーミングが重要である。インデント（字下げ）を適切に行い、マクロの条件分岐や反復構造などを把握しやすくする、効果的にコメントを入れるなど、コードの読みやすさについても心掛けたい。</p>
</section>
<section id="小さく始める" class="level3" data-number="2.7.7">
<h3 data-number="2.7.7" class="anchored" data-anchor-id="小さく始める"><span class="header-section-number">2.7.7</span> 小さく始める</h3>
<p>小さく始めて、少しずつ理解するのが習得のコツである。最初はマクロ変数を使うところからでもよい。基本プログラムによく変更する部分だけをマクロ変数化して、プラクマの電用管理を設定可能にする、先行するすプロジェクトの設定を改めてせることも多いし、実はここまででも十分な効果が着込まれる場合がある。また、簡単なマクロプログラムを作成する際給与も設ける。マクロを作成する手順として、まずマクロを含まないプログラムを作成し、少しずつマクロ化していくアプローチが推奨されている。これによりマクロプロセッサに命令があるかが明り分けすされる。</p>
</section>
</section>
<section id="マクロの実例" class="level2" data-number="2.8">
<h2 data-number="2.8" class="anchored" data-anchor-id="マクロの実例"><span class="header-section-number">2.8</span> マクロの実例</h2>
<p>筆者らが業務で実際に作成したマクロプログラムを紹介する。筆者で簡切と練習する事例であり、なるべく小題のプログラム編集で対応できるよう意図している。</p>
<section id="特定のフォルダ内のsasデータセットを1つのexcelファイルに変換する" class="level3" data-number="2.8.1">
<h3 data-number="2.8.1" class="anchored" data-anchor-id="特定のフォルダ内のsasデータセットを1つのexcelファイルに変換する"><span class="header-section-number">2.8.1</span> 特定のフォルダ内のSASデータセットを1つのExcelファイルに変換する</h3>
<p>SASデータセットをデータセット別にシートを分けてExcelファイルに変換してほしいと依頼を受ける。もちろんデータセットの教だけprocexportまたはsetステートメントを記述してもよいのだが、そのような縮り返し処理はマクロ化したときに自動転するのがよい。なお、以下でマクロプログラムが直後されたフォルダ内のSASデータセットを、同フォルダに既定のExcelファイルを指定する必要がある。</p>
<div class="sourceCode" id="cb12" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb12-1"><a href="#cb12-1"></a>%macro sas2xlsx;</span>
<span id="cb12-2"><a href="#cb12-2"></a></span>
<span id="cb12-3"><a href="#cb12-3"></a>    /* データセット一覧を取得する */</span>
<span id="cb12-4"><a href="#cb12-4"></a>    proc sql noprint;</span>
<span id="cb12-5"><a href="#cb12-5"></a>        select memname into :dsname1-</span>
<span id="cb12-6"><a href="#cb12-6"></a>        from dictionary.tables</span>
<span id="cb12-7"><a href="#cb12-7"></a>        where libname = "SAS";</span>
<span id="cb12-8"><a href="#cb12-8"></a>    quit;</span>
<span id="cb12-9"><a href="#cb12-9"></a></span>
<span id="cb12-10"><a href="#cb12-10"></a>    do i = 1 to &amp;sqlobs.;</span>
<span id="cb12-11"><a href="#cb12-11"></a></span>
<span id="cb12-12"><a href="#cb12-12"></a>        data work.&amp;&amp;&amp;dsname&amp;i..;</span>
<span id="cb12-13"><a href="#cb12-13"></a>            set sas.&amp;&amp;&amp;dsname&amp;i..;</span>
<span id="cb12-14"><a href="#cb12-14"></a>        run;</span>
<span id="cb12-15"><a href="#cb12-15"></a></span>
<span id="cb12-16"><a href="#cb12-16"></a>    %end;</span>
<span id="cb12-17"><a href="#cb12-17"></a></span>
<span id="cb12-18"><a href="#cb12-18"></a>%mend;</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>上記マクロでは、現在でデータセットのあるフォルダを出力先のExcelファイルに指定する必要がある。そこで、上記マクロプログラムが配置されたフォルダ内のSASデータセットを、同フォルダに既定のExcelファイルとして出力するようにプログラムを変更すれば、条件ごとにプログラムを編集する必要がなくなる。（もちろん不測の事象が生じする能性があるため、SASログ確認および出力ファイルの確認は時う。）</p>
</section>
<section id="特定のフォルダ内のsasデータセットをxptファイルに一括変換する" class="level3" data-number="2.8.2">
<h3 data-number="2.8.2" class="anchored" data-anchor-id="特定のフォルダ内のsasデータセットをxptファイルに一括変換する"><span class="header-section-number">2.8.2</span> 特定のフォルダ内のSASデータセットをXPTファイルに一括変換する</h3>
<p>医療機関医療品の承認申請では、原則として申請電子データ提出が求められており、既導データをXPT形式で提出する必要がある。このためSASデータセットをXPT形式に変換する機会がよくある。なお、以下ではfilel.sasという名前でマクロプログラムを保存し、指定したデータセットが配置されたフォルダに配置してくれる。細部の具い事例である。</p>
<div class="sourceCode" id="cb13" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb13-1"><a href="#cb13-1"></a>/* 指定フォルダ内のSASデータセットをXPTファイルに一括変換する; */</span>
<span id="cb13-2"><a href="#cb13-2"></a>option nofmterr nologic print symbol;</span>
<span id="cb13-3"><a href="#cb13-3"></a>%let xpt = %str(C:\workXpt);  </span>
<span id="cb13-4"><a href="#cb13-4"></a>%let sas = %str(C:\workXsas); </span>
<span id="cb13-5"><a href="#cb13-5"></a></span>
<span id="cb13-6"><a href="#cb13-6"></a>libname _sas "&amp;sas.";</span>
<span id="cb13-7"><a href="#cb13-7"></a>libname _xpt xport "&amp;sas.";</span>
<span id="cb13-8"><a href="#cb13-8"></a></span>
<span id="cb13-9"><a href="#cb13-9"></a>%macro sas2xpt(sptdir, sasdir);</span>
<span id="cb13-10"><a href="#cb13-10"></a></span>
<span id="cb13-11"><a href="#cb13-11"></a>/* ～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～; */</span>
<span id="cb13-12"><a href="#cb13-12"></a>/* ファイル一覧を取得する; */</span>
<span id="cb13-13"><a href="#cb13-13"></a>/* ～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～; */</span>
<span id="cb13-14"><a href="#cb13-14"></a>%filelist(</span>
<span id="cb13-15"><a href="#cb13-15"></a>    directory=%superq(sasdir), /* Directory to read */</span>
<span id="cb13-16"><a href="#cb13-16"></a>    out=_sas,                  /* Output data set to create */</span>
<span id="cb13-17"><a href="#cb13-17"></a>    extensions=sas7bdat        /* Space delimited extensions to include. Not case</span>
<span id="cb13-18"><a href="#cb13-18"></a>                                sensitive. Leave blank or set other based on extension */</span>
<span id="cb13-19"><a href="#cb13-19"></a>)</span>
<span id="cb13-20"><a href="#cb13-20"></a></span>
<span id="cb13-21"><a href="#cb13-21"></a>/* ファイル一覧を読み込む; */</span>
<span id="cb13-22"><a href="#cb13-22"></a>proc sql noprint;</span>
<span id="cb13-23"><a href="#cb13-23"></a>    select dsname into :_dsname1 - </span>
<span id="cb13-24"><a href="#cb13-24"></a>    from _sas;</span>
<span id="cb13-25"><a href="#cb13-25"></a>quit;</span>
<span id="cb13-26"><a href="#cb13-26"></a></span>
<span id="cb13-27"><a href="#cb13-27"></a>/* 各ファイルがない場合は終了する; */</span>
<span id="cb13-28"><a href="#cb13-28"></a>%if &amp;sqlobs. = 0 %then %return;</span>
<span id="cb13-29"><a href="#cb13-29"></a></span>
<span id="cb13-30"><a href="#cb13-30"></a>libname _sas %superq(sasdir)" access=readonly;</span>
<span id="cb13-31"><a href="#cb13-31"></a></span>
<span id="cb13-32"><a href="#cb13-32"></a>%do i = 1 to &amp;sqlobs.;</span>
<span id="cb13-33"><a href="#cb13-33"></a>/* ～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～; */</span>
<span id="cb13-34"><a href="#cb13-34"></a>/* SAS7BDATをXPTに変換する; */</span>
<span id="cb13-35"><a href="#cb13-35"></a>/* ～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～; */</span>
<span id="cb13-36"><a href="#cb13-36"></a>libname _xpt xport "&amp;sptdir\&amp;&amp;&amp;_dsname&amp;i..&amp;_xpt";</span>
<span id="cb13-37"><a href="#cb13-37"></a>data _xpt.&amp;&amp;&amp;_dsname&amp;i..;</span>
<span id="cb13-38"><a href="#cb13-38"></a>    set _sas.&amp;&amp;&amp;_dsname&amp;i..;</span>
<span id="cb13-39"><a href="#cb13-39"></a>run;</span>
<span id="cb13-40"><a href="#cb13-40"></a>%end;</span>
<span id="cb13-41"><a href="#cb13-41"></a></span>
<span id="cb13-42"><a href="#cb13-42"></a>/* ～～～～～～終了処理～～～～～～; */</span>
<span id="cb13-43"><a href="#cb13-43"></a>libname _sas clear;</span>
<span id="cb13-44"><a href="#cb13-44"></a>libname _xpt clear;</span>
<span id="cb13-45"><a href="#cb13-45"></a>proc datasets library=work nolist;</span>
<span id="cb13-46"><a href="#cb13-46"></a>    delete _sas;</span>
<span id="cb13-47"><a href="#cb13-47"></a>quit;</span>
<span id="cb13-48"><a href="#cb13-48"></a>run;</span>
<span id="cb13-49"><a href="#cb13-49"></a>quit;</span>
<span id="cb13-50"><a href="#cb13-50"></a></span>
<span id="cb13-51"><a href="#cb13-51"></a>%mend;</span>
<span id="cb13-52"><a href="#cb13-52"></a></span>
<span id="cb13-53"><a href="#cb13-53"></a>%sas2xpt(sptdir=%superq(xpt), sasdir=%superq(sas))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="終わりに" class="level2" data-number="2.9">
<h2 data-number="2.9" class="anchored" data-anchor-id="終わりに"><span class="header-section-number">2.9</span> 終わりに</h2>
<p>マクロ言語を対象にマクロの基礎から応用、そして利用のコツを概説した。マクロプロセッサにプログラムを書いてもらうライブラリ化により大量軸な共通化に及ぶまで、マクロは様々な場面で雄用いと感じてもらえれば幸いしたい。しかし、一度にすべてを理解する必要はなく、筆者ももともくさんのトライ&amp;エラーを経験し、必要に迫られながら時間をかけてレットたという自分求むのが実情である。やがり理解できる自然に身につくき交鎖に考え、引用文献もご参照頂ければ幸いである。マクロプロセッサは、そこと出番を待っている。</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "コピーしました");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "コピーしました");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            trigger: 'click',
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            positionFixed: true,
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://github.com/kkts1010/kkts1010.github.io/">
<p>Kota Sakamoto</p>
</a>
  </li>  
</ul>
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/kkts1010/kkts1010.github.io/">
<p>Kota Sakamoto</p>
</a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/kkt_1010">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>