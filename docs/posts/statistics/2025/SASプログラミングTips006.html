<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.30">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="坂本航太">

<title>臨床試験における有害事象データの集計：PROC SQL vs DATA STEP徹底比較 – Kota Sakamoto</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-9849038e97c5862c14c4eb81893d019b.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-945f87a38397f0f3b8ef34e2f394b6bc.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "一致なし",
    "search-matching-documents-text": "一致した文書",
    "search-copy-link-title": "検索へのリンクをコピー",
    "search-hide-matches-text": "追加の検索結果を非表示",
    "search-more-match-text": "追加の検索結果",
    "search-more-matches-text": "追加の検索結果",
    "search-clear-button-title": "消去",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "取消",
    "search-submit-button-title": "検索",
    "search-label": "サーチ"
  }
}</script>


<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Kota Sakamoto</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="サーチ"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="ナビゲーションを切り替える" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../posts/statistics/index.html"> 
<span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../posts/Web_tools/Web_tools.html"> 
<span class="menu-text">Web Tools</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/kkts1010/kkts1010.github.io/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-left">
      <h1 class="title">臨床試験における有害事象データの集計：PROC SQL vs DATA STEP徹底比較</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">SAS</div>
                <div class="quarto-category">解析プログラミング</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta column-page-left">

      <div>
      <div class="quarto-title-meta-heading">作者</div>
      <div class="quarto-title-meta-contents">
               <p>坂本航太 </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">公開</div>
      <div class="quarto-title-meta-contents">
        <p class="date">2025年6月28日</p>
      </div>
    </div>
    
      <div>
      <div class="quarto-title-meta-heading">更新日</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">2025年6月28日</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目次</h2>
   
  <ul class="collapse">
  <li><a href="#臨床試験における有害事象データの集計proc-sql-vs-data-step徹底比較" id="toc-臨床試験における有害事象データの集計proc-sql-vs-data-step徹底比較" class="nav-link active" data-scroll-target="#臨床試験における有害事象データの集計proc-sql-vs-data-step徹底比較"><span class="header-section-number">1</span> 臨床試験における有害事象データの集計：PROC SQL vs DATA STEP徹底比較</a>
  <ul class="collapse">
  <li><a href="#治療群別有害事象集計の実装" id="toc-治療群別有害事象集計の実装" class="nav-link" data-scroll-target="#治療群別有害事象集計の実装"><span class="header-section-number">1.1</span> 治療群別有害事象集計の実装</a></li>
  <li><a href="#修正されたappendixプログラム列順序修正版" id="toc-修正されたappendixプログラム列順序修正版" class="nav-link" data-scroll-target="#修正されたappendixプログラム列順序修正版"><span class="header-section-number">1.2</span> 修正されたAppendixプログラム（列順序修正版）</a></li>
  <li><a href="#結果の検証とデバッグ" id="toc-結果の検証とデバッグ" class="nav-link" data-scroll-target="#結果の検証とデバッグ"><span class="header-section-number">1.3</span> 結果の検証とデバッグ</a></li>
  <li><a href="#初心者向けsql学習のポイント" id="toc-初心者向けsql学習のポイント" class="nav-link" data-scroll-target="#初心者向けsql学習のポイント"><span class="header-section-number">1.4</span> 初心者向けSQL学習のポイント</a></li>
  <li><a href="#まとめ" id="toc-まとめ" class="nav-link" data-scroll-target="#まとめ"><span class="header-section-number">1.5</span> まとめ</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block column-page-left" id="quarto-document-content">





<section id="臨床試験における有害事象データの集計proc-sql-vs-data-step徹底比較" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> 臨床試験における有害事象データの集計：PROC SQL vs DATA STEP徹底比較</h1>
<p>臨床試験における有害事象（Adverse Event: AE）の集計は、薬剤の安全性評価において最も重要な分析の一つです。特に治療群間での比較は、薬剤の安全性プロファイルを理解する上で欠かせません。本記事では、標準的なADSL（Subject-Level Analysis Dataset）とADAE（Adverse Event Analysis Dataset）を使用して、Treatment群、Control群、Total の3つの観点からSOC（System Organ Class）/PT（Preferred Term）別の有害事象集計を実装する方法を詳しく解説します。</p>
<p>標準データセットの作成 ADSLデータセット（被験者レベル）</p>
<div class="sourceCode" id="cb1" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb1-1"><a href="#cb1-1"></a>/* ADSL（被験者レベル分析データセット）の作成 */</span>
<span id="cb1-2"><a href="#cb1-2"></a>data adsl;</span>
<span id="cb1-3"><a href="#cb1-3"></a>    length usubjid $20 subjid $10 arm $20 saffl $1;</span>
<span id="cb1-4"><a href="#cb1-4"></a>    </span>
<span id="cb1-5"><a href="#cb1-5"></a>    /* 50名の被験者データを作成 */</span>
<span id="cb1-6"><a href="#cb1-6"></a>    do i = 1 to 50;</span>
<span id="cb1-7"><a href="#cb1-7"></a>        usubjid = cats("STUDY001-", put(i, z3.));</span>
<span id="cb1-8"><a href="#cb1-8"></a>        subjid = put(i, z3.);</span>
<span id="cb1-9"><a href="#cb1-9"></a>        </span>
<span id="cb1-10"><a href="#cb1-10"></a>        /* 治療群の割り当て（2:1でTreatment:Placebo） */</span>
<span id="cb1-11"><a href="#cb1-11"></a>        if mod(i, 3) = 0 then arm = "Placebo";</span>
<span id="cb1-12"><a href="#cb1-12"></a>        else arm = "Treatment";</span>
<span id="cb1-13"><a href="#cb1-13"></a>        </span>
<span id="cb1-14"><a href="#cb1-14"></a>        /* 安全性解析対象フラグ */</span>
<span id="cb1-15"><a href="#cb1-15"></a>        saffl = "Y";</span>
<span id="cb1-16"><a href="#cb1-16"></a>        </span>
<span id="cb1-17"><a href="#cb1-17"></a>        output;</span>
<span id="cb1-18"><a href="#cb1-18"></a>    end;</span>
<span id="cb1-19"><a href="#cb1-19"></a>    drop i;</span>
<span id="cb1-20"><a href="#cb1-20"></a>run;</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>DATA STEPの基本解説：</strong></p>
<ul>
<li><p><code>data adsl;</code> - 新しいデータセット「adsl」を作成開始</p></li>
<li><p><code>length</code> - 変数の型と最大長を事前定義（$は文字型、数値は文字数）</p></li>
<li><p><code>do i = 1 to 50;</code> - 1から50まで繰り返し処理（50人の被験者作成）</p></li>
<li><p><code>cats()</code> - 複数の文字列を結合する関数（空白なしで連結）</p></li>
<li><p><code>put(i, z3.)</code> - 数値iを3桁のゼロパディング文字列に変換（001, 002, …）</p></li>
<li><p><code>mod(i, 3)</code> - iを3で割った余りを計算（0, 1, 2のサイクル）</p></li>
<li><p><code>output;</code> - 現在の変数値でレコードを出力</p></li>
<li><p><code>drop i;</code> - 作業用変数iを最終データセットから除外</p></li>
<li><p><code>run;</code> - DATA STEPの実行</p></li>
</ul>
<section id="adaeデータセット有害事象レベル" class="level3" data-number="1.0.1">
<h3 data-number="1.0.1" class="anchored" data-anchor-id="adaeデータセット有害事象レベル"><span class="header-section-number">1.0.1</span> ADAEデータセット（有害事象レベル）</h3>
<div class="sourceCode" id="cb2" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb2-1"><a href="#cb2-1"></a>/* ADAE（有害事象分析データセット）の作成 - より豊富なデータ */</span>
<span id="cb2-2"><a href="#cb2-2"></a>data adae;</span>
<span id="cb2-3"><a href="#cb2-3"></a>    length usubjid $20 subjid $10 aesoc $50 aedecod $100 aeser $1 aerel $1 aestdy 8;</span>
<span id="cb2-4"><a href="#cb2-4"></a>    </span>
<span id="cb2-5"><a href="#cb2-5"></a>    /* 心臓障害の有害事象 */</span>
<span id="cb2-6"><a href="#cb2-6"></a>    usubjid = "STUDY001-001"; subjid = "001"; aesoc = "心臓障害"; aedecod = "完全房室ブロック"; aeser = "Y"; aerel = "Y"; aestdy = 15; output;</span>
<span id="cb2-7"><a href="#cb2-7"></a>    usubjid = "STUDY001-001"; subjid = "001"; aesoc = "心臓障害"; aedecod = "徐脈"; aeser = "N"; aerel = "Y"; aestdy = 22; output;</span>
<span id="cb2-8"><a href="#cb2-8"></a>    </span>
<span id="cb2-9"><a href="#cb2-9"></a>    usubjid = "STUDY001-002"; subjid = "002"; aesoc = "心臓障害"; aedecod = "心不全慢性"; aeser = "Y"; aerel = "Y"; aestdy = 8; output;</span>
<span id="cb2-10"><a href="#cb2-10"></a>    usubjid = "STUDY001-002"; subjid = "002"; aesoc = "心臓障害"; aedecod = "心不全"; aeser = "N"; aerel = "N"; aestdy = 45; output;</span>
<span id="cb2-11"><a href="#cb2-11"></a>    </span>
<span id="cb2-12"><a href="#cb2-12"></a>    usubjid = "STUDY001-004"; subjid = "004"; aesoc = "心臓障害"; aedecod = "動悸"; aeser = "N"; aerel = "Y"; aestdy = 3; output;</span>
<span id="cb2-13"><a href="#cb2-13"></a>    usubjid = "STUDY001-007"; subjid = "007"; aesoc = "心臓障害"; aedecod = "洞停止"; aeser = "N"; aerel = "N"; aestdy = 34; output;</span>
<span id="cb2-14"><a href="#cb2-14"></a>    usubjid = "STUDY001-010"; subjid = "010"; aesoc = "心臓障害"; aedecod = "完全房室ブロック"; aeser = "Y"; aerel = "Y"; aestdy = 25; output;</span>
<span id="cb2-15"><a href="#cb2-15"></a>    usubjid = "STUDY001-013"; subjid = "013"; aesoc = "心臓障害"; aedecod = "徐脈"; aeser = "N"; aerel = "Y"; aestdy = 11; output;</span>
<span id="cb2-16"><a href="#cb2-16"></a>    usubjid = "STUDY001-016"; subjid = "016"; aesoc = "心臓障害"; aedecod = "心房細動"; aeser = "Y"; aerel = "N"; aestdy = 67; output;</span>
<span id="cb2-17"><a href="#cb2-17"></a>    usubjid = "STUDY001-019"; subjid = "019"; aesoc = "心臓障害"; aedecod = "狭心症"; aeser = "N"; aerel = "Y"; aestdy = 44; output;</span>
<span id="cb2-18"><a href="#cb2-18"></a>    </span>
<span id="cb2-19"><a href="#cb2-19"></a>    /* 胃腸障害の有害事象 */</span>
<span id="cb2-20"><a href="#cb2-20"></a>    usubjid = "STUDY001-005"; subjid = "005"; aesoc = "胃腸障害"; aedecod = "悪心"; aeser = "N"; aerel = "Y"; aestdy = 2; output;</span>
<span id="cb2-21"><a href="#cb2-21"></a>    usubjid = "STUDY001-005"; subjid = "005"; aesoc = "胃腸障害"; aedecod = "嘔吐"; aeser = "N"; aerel = "Y"; aestdy = 5; output;</span>
<span id="cb2-22"><a href="#cb2-22"></a>    usubjid = "STUDY001-008"; subjid = "008"; aesoc = "胃腸障害"; aedecod = "下痢"; aeser = "N"; aerel = "Y"; aestdy = 18; output;</span>
<span id="cb2-23"><a href="#cb2-23"></a>    usubjid = "STUDY001-011"; subjid = "011"; aesoc = "胃腸障害"; aedecod = "便秘"; aeser = "N"; aerel = "N"; aestdy = 28; output;</span>
<span id="cb2-24"><a href="#cb2-24"></a>    usubjid = "STUDY001-014"; subjid = "014"; aesoc = "胃腸障害"; aedecod = "悪心"; aeser = "N"; aerel = "Y"; aestdy = 4; output;</span>
<span id="cb2-25"><a href="#cb2-25"></a>    usubjid = "STUDY001-017"; subjid = "017"; aesoc = "胃腸障害"; aedecod = "腹痛"; aeser = "N"; aerel = "N"; aestdy = 32; output;</span>
<span id="cb2-26"><a href="#cb2-26"></a>    usubjid = "STUDY001-020"; subjid = "020"; aesoc = "胃腸障害"; aedecod = "消化不良"; aeser = "N"; aerel = "Y"; aestdy = 12; output;</span>
<span id="cb2-27"><a href="#cb2-27"></a>    </span>
<span id="cb2-28"><a href="#cb2-28"></a>    /* 神経系障害の有害事象 */</span>
<span id="cb2-29"><a href="#cb2-29"></a>    usubjid = "STUDY001-006"; subjid = "006"; aesoc = "神経系障害"; aedecod = "頭痛"; aeser = "N"; aerel = "Y"; aestdy = 1; output;</span>
<span id="cb2-30"><a href="#cb2-30"></a>    usubjid = "STUDY001-006"; subjid = "006"; aesoc = "神経系障害"; aedecod = "めまい"; aeser = "N"; aerel = "Y"; aestdy = 14; output;</span>
<span id="cb2-31"><a href="#cb2-31"></a>    usubjid = "STUDY001-009"; subjid = "009"; aesoc = "神経系障害"; aedecod = "傾眠"; aeser = "N"; aerel = "Y"; aestdy = 7; output;</span>
<span id="cb2-32"><a href="#cb2-32"></a>    usubjid = "STUDY001-012"; subjid = "012"; aesoc = "神経系障害"; aedecod = "頭痛"; aeser = "N"; aerel = "N"; aestdy = 21; output;</span>
<span id="cb2-33"><a href="#cb2-33"></a>    usubjid = "STUDY001-015"; subjid = "015"; aesoc = "神経系障害"; aedecod = "めまい"; aeser = "N"; aerel = "N"; aestdy = 19; output;</span>
<span id="cb2-34"><a href="#cb2-34"></a>    usubjid = "STUDY001-018"; subjid = "018"; aesoc = "神経系障害"; aedecod = "振戦"; aeser = "N"; aerel = "Y"; aestdy = 29; output;</span>
<span id="cb2-35"><a href="#cb2-35"></a>    </span>
<span id="cb2-36"><a href="#cb2-36"></a>    /* 皮膚および皮下組織障害 */</span>
<span id="cb2-37"><a href="#cb2-37"></a>    usubjid = "STUDY001-021"; subjid = "021"; aesoc = "皮膚および皮下組織障害"; aedecod = "発疹"; aeser = "N"; aerel = "Y"; aestdy = 9; output;</span>
<span id="cb2-38"><a href="#cb2-38"></a>    usubjid = "STUDY001-022"; subjid = "022"; aesoc = "皮膚および皮下組織障害"; aedecod = "そう痒症"; aeser = "N"; aerel = "Y"; aestdy = 16; output;</span>
<span id="cb2-39"><a href="#cb2-39"></a>    usubjid = "STUDY001-023"; subjid = "023"; aesoc = "皮膚および皮下組織障害"; aedecod = "紅斑"; aeser = "N"; aerel = "N"; aestdy = 23; output;</span>
<span id="cb2-40"><a href="#cb2-40"></a>    </span>
<span id="cb2-41"><a href="#cb2-41"></a>    /* 一般・全身障害および投与部位の状態 */</span>
<span id="cb2-42"><a href="#cb2-42"></a>    usubjid = "STUDY001-024"; subjid = "024"; aesoc = "一般・全身障害および投与部位の状態"; aedecod = "疲労"; aeser = "N"; aerel = "Y"; aestdy = 5; output;</span>
<span id="cb2-43"><a href="#cb2-43"></a>    usubjid = "STUDY001-025"; subjid = "025"; aesoc = "一般・全身障害および投与部位の状態"; aedecod = "発熱"; aeser = "N"; aerel = "N"; aestdy = 13; output;</span>
<span id="cb2-44"><a href="#cb2-44"></a>    usubjid = "STUDY001-026"; subjid = "026"; aesoc = "一般・全身障害および投与部位の状態"; aedecod = "無力症"; aeser = "N"; aerel = "Y"; aestdy = 27; output;</span>
<span id="cb2-45"><a href="#cb2-45"></a>run;</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Statement解説：</strong></p>
<ul>
<li><p><strong>ADAEデータの特徴：</strong></p>
<ul>
<li><p><strong>aesoc</strong>: 器官別大分類（MedDRA SOC相当）</p></li>
<li><p><strong>aedecod</strong>: 基本語（MedDRA PT相当）</p></li>
<li><p><strong>aerel</strong>: 因果関係（Y=あり, N=なし）</p></li>
<li><p><strong>aeser</strong>: 重篤性（Y=重篤, N=非重篤）</p></li>
<li><p><strong>aestdy</strong>: 投与開始からの日数</p></li>
</ul></li>
</ul>
</section>
<section id="治療群別有害事象集計の実装" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="治療群別有害事象集計の実装"><span class="header-section-number">1.1</span> 治療群別有害事象集計の実装</h2>
<section id="step1-安全性解析対象データの準備" class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="step1-安全性解析対象データの準備"><span class="header-section-number">1.1.1</span> Step1: 安全性解析対象データの準備</h3>
<div class="sourceCode" id="cb3" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb3-1"><a href="#cb3-1"></a>/* Step 3-1: 安全性解析対象データの準備と母集団サイズ取得 */</span>
<span id="cb3-2"><a href="#cb3-2"></a>proc sql;</span>
<span id="cb3-3"><a href="#cb3-3"></a>    /* 安全性解析対象のAEデータ抽出（ARM情報付き） */</span>
<span id="cb3-4"><a href="#cb3-4"></a>    create table ae_safety_arm as</span>
<span id="cb3-5"><a href="#cb3-5"></a>    select a.usubjid, a.aesoc, a.aedecod, a.aerel, a.aeser, </span>
<span id="cb3-6"><a href="#cb3-6"></a>           case when s.arm = "Placebo" then "Control" </span>
<span id="cb3-7"><a href="#cb3-7"></a>                else s.arm end as arm</span>
<span id="cb3-8"><a href="#cb3-8"></a>    from adae a</span>
<span id="cb3-9"><a href="#cb3-9"></a>    inner join adsl s on a.usubjid = s.usubjid and s.saffl = "Y";</span>
<span id="cb3-10"><a href="#cb3-10"></a>    </span>
<span id="cb3-11"><a href="#cb3-11"></a>    /* 各ARM別とTOTALの母集団サイズ取得 */</span>
<span id="cb3-12"><a href="#cb3-12"></a>    select count(*) into :total_n</span>
<span id="cb3-13"><a href="#cb3-13"></a>    from adsl</span>
<span id="cb3-14"><a href="#cb3-14"></a>    where saffl = "Y";</span>
<span id="cb3-15"><a href="#cb3-15"></a>    </span>
<span id="cb3-16"><a href="#cb3-16"></a>    select count(*) into :treatment_n</span>
<span id="cb3-17"><a href="#cb3-17"></a>    from adsl  </span>
<span id="cb3-18"><a href="#cb3-18"></a>    where saffl = "Y" and arm = "Treatment";</span>
<span id="cb3-19"><a href="#cb3-19"></a>    </span>
<span id="cb3-20"><a href="#cb3-20"></a>    select count(*) into :control_n</span>
<span id="cb3-21"><a href="#cb3-21"></a>    from adsl</span>
<span id="cb3-22"><a href="#cb3-22"></a>    where saffl = "Y" and arm = "Placebo";  /* 元データではPlacebo */</span>
<span id="cb3-23"><a href="#cb3-23"></a>quit;</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>PROC SQLの基本解説：</strong></p>
<p><strong>1. PROC SQLの開始と終了：</strong></p>
<ul>
<li><p><code>proc sql;</code> - SQLプロシジャの開始</p></li>
<li><p><code>quit;</code> - SQLプロシジャの終了（他のプロシジャは<code>run;</code>だがSQLは<code>quit;</code>）</p></li>
</ul>
<p><strong>2. CREATE TABLE文：</strong></p>
<ul>
<li><p><code>create table ae_safety_arm as</code> - 新しいテーブル「ae_safety_arm」を作成</p></li>
<li><p><code>select ... from ... where ...;</code> の結果でテーブルを作成</p></li>
</ul>
<p><strong>3. SELECT文の基本構造：</strong></p>
<div class="sourceCode" id="cb4" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb4-1"><a href="#cb4-1"></a>select 列名1, 列名2, 計算式 as 新しい列名 from テーブル名 where 条件;</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>4. CASE文（条件分岐）：</strong></p>
<div class="sourceCode" id="cb5" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb5-1"><a href="#cb5-1"></a>case when 条件1 then 値1</span>
<span id="cb5-2"><a href="#cb5-2"></a>     else 値2 end as 新列名</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>IF-THEN-ELSEのSQL版</p></li>
<li><p><code>case when s.arm = "Placebo" then "Control"</code> - PlaceboをControlに表示変更</p></li>
</ul>
<p><strong>5. INNER JOIN（内部結合）：</strong></p>
<div class="sourceCode" id="cb6" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb6-1"><a href="#cb6-1"></a>from adae a</span>
<span id="cb6-2"><a href="#cb6-2"></a>inner join adsl s on a.usubjid = s.usubjid and s.saffl = "Y"</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>2つのテーブルを結合</p></li>
<li><p><code>a</code>, <code>s</code> はテーブルエイリアス（短縮名）</p></li>
<li><p><code>on</code> の条件を満たすレコードのみ結果に含める</p></li>
<li><p><code>and s.saffl = "Y"</code> で安全性解析対象のみ抽出</p></li>
</ul>
<p><strong>6. INTO句（マクロ変数への格納）：</strong></p>
<div class="sourceCode" id="cb7" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb7-1"><a href="#cb7-1"></a>select count(*) into :total_n</span>
<span id="cb7-2"><a href="#cb7-2"></a>from adsl</span>
<span id="cb7-3"><a href="#cb7-3"></a>where saffl = "Y";</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p><code>count(*)</code> - レコード数をカウント</p></li>
<li><p><code>into :total_n</code> - 結果をマクロ変数&amp;total_nに格納</p></li>
<li><p>後で分母として使用</p></li>
</ul>
</section>
<section id="step2-治療群別socpt集計の中核部分" class="level3" data-number="1.1.2">
<h3 data-number="1.1.2" class="anchored" data-anchor-id="step2-治療群別socpt集計の中核部分"><span class="header-section-number">1.1.2</span> Step2: 治療群別SOC/PT集計の中核部分</h3>
<div class="sourceCode" id="cb8" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb8-1"><a href="#cb8-1"></a>proc sql;</span>
<span id="cb8-2"><a href="#cb8-2"></a>    create table ae_comprehensive as</span>
<span id="cb8-3"><a href="#cb8-3"></a>    </span>
<span id="cb8-4"><a href="#cb8-4"></a>    /* SOCレベル - ARM別 */</span>
<span id="cb8-5"><a href="#cb8-5"></a>    select aesoc, "" as aept, arm as arm_group,</span>
<span id="cb8-6"><a href="#cb8-6"></a>           compress(put(count(distinct usubjid), 8.)) || '(' || </span>
<span id="cb8-7"><a href="#cb8-7"></a>           compress(put((count(distinct usubjid)/</span>
<span id="cb8-8"><a href="#cb8-8"></a>               case when arm = "Treatment" then &amp;treatment_n</span>
<span id="cb8-9"><a href="#cb8-9"></a>                    when arm = "Control" then &amp;control_n</span>
<span id="cb8-10"><a href="#cb8-10"></a>                    else &amp;total_n end)*100, 8.1)) || ')' as c,</span>
<span id="cb8-11"><a href="#cb8-11"></a>           case when arm = "Treatment" then 1</span>
<span id="cb8-12"><a href="#cb8-12"></a>                when arm = "Control" then 2</span>
<span id="cb8-13"><a href="#cb8-13"></a>                else 3 end as arm_order</span>
<span id="cb8-14"><a href="#cb8-14"></a>    from (select aesoc, usubjid, arm</span>
<span id="cb8-15"><a href="#cb8-15"></a>          from ae_safety_arm</span>
<span id="cb8-16"><a href="#cb8-16"></a>          group by aesoc, usubjid, arm) as subj_arm</span>
<span id="cb8-17"><a href="#cb8-17"></a>    group by aesoc, arm</span>
<span id="cb8-18"><a href="#cb8-18"></a>    </span>
<span id="cb8-19"><a href="#cb8-19"></a>    union all</span>
<span id="cb8-20"><a href="#cb8-20"></a>    </span>
<span id="cb8-21"><a href="#cb8-21"></a>    /* SOCレベル - Total */</span>
<span id="cb8-22"><a href="#cb8-22"></a>    select aesoc, "" as aept, "Total" as arm_group,</span>
<span id="cb8-23"><a href="#cb8-23"></a>           compress(put(count(distinct usubjid), 8.)) || '(' || </span>
<span id="cb8-24"><a href="#cb8-24"></a>           compress(put((count(distinct usubjid)/&amp;total_n)*100, 8.1)) || ')' as c,</span>
<span id="cb8-25"><a href="#cb8-25"></a>           3 as arm_order</span>
<span id="cb8-26"><a href="#cb8-26"></a>    from (select aesoc, usubjid</span>
<span id="cb8-27"><a href="#cb8-27"></a>          from ae_safety_arm</span>
<span id="cb8-28"><a href="#cb8-28"></a>          group by aesoc, usubjid) as subj_total</span>
<span id="cb8-29"><a href="#cb8-29"></a>    group by aesoc</span>
<span id="cb8-30"><a href="#cb8-30"></a>    </span>
<span id="cb8-31"><a href="#cb8-31"></a>    union all</span>
<span id="cb8-32"><a href="#cb8-32"></a>    </span>
<span id="cb8-33"><a href="#cb8-33"></a>    /* PTレベル - ARM別 */</span>
<span id="cb8-34"><a href="#cb8-34"></a>    select aesoc, aedecod as aept, arm as arm_group,</span>
<span id="cb8-35"><a href="#cb8-35"></a>           compress(put(count(distinct usubjid), 8.)) || '(' || </span>
<span id="cb8-36"><a href="#cb8-36"></a>           compress(put((count(distinct usubjid)/</span>
<span id="cb8-37"><a href="#cb8-37"></a>               case when arm = "Treatment" then &amp;treatment_n</span>
<span id="cb8-38"><a href="#cb8-38"></a>                    when arm = "Control" then &amp;control_n</span>
<span id="cb8-39"><a href="#cb8-39"></a>                    else &amp;total_n end)*100, 8.1)) || ')' as c,</span>
<span id="cb8-40"><a href="#cb8-40"></a>           case when arm = "Treatment" then 1</span>
<span id="cb8-41"><a href="#cb8-41"></a>                when arm = "Control" then 2</span>
<span id="cb8-42"><a href="#cb8-42"></a>                else 3 end as arm_order</span>
<span id="cb8-43"><a href="#cb8-43"></a>    from (select aesoc, aedecod, usubjid, arm</span>
<span id="cb8-44"><a href="#cb8-44"></a>          from ae_safety_arm</span>
<span id="cb8-45"><a href="#cb8-45"></a>          group by aesoc, aedecod, usubjid, arm) as subj_arm</span>
<span id="cb8-46"><a href="#cb8-46"></a>    group by aesoc, aedecod, arm</span>
<span id="cb8-47"><a href="#cb8-47"></a>    </span>
<span id="cb8-48"><a href="#cb8-48"></a>    union all</span>
<span id="cb8-49"><a href="#cb8-49"></a>    </span>
<span id="cb8-50"><a href="#cb8-50"></a>    /* PTレベル - Total */</span>
<span id="cb8-51"><a href="#cb8-51"></a>    select aesoc, aedecod as aept, "Total" as arm_group,</span>
<span id="cb8-52"><a href="#cb8-52"></a>           compress(put(count(distinct usubjid), 8.)) || '(' || </span>
<span id="cb8-53"><a href="#cb8-53"></a>           compress(put((count(distinct usubjid)/&amp;total_n)*100, 8.1)) || ')' as c,</span>
<span id="cb8-54"><a href="#cb8-54"></a>           3 as arm_order</span>
<span id="cb8-55"><a href="#cb8-55"></a>    from (select aesoc, aedecod, usubjid</span>
<span id="cb8-56"><a href="#cb8-56"></a>          from ae_safety_arm</span>
<span id="cb8-57"><a href="#cb8-57"></a>          group by aesoc, aedecod, usubjid) as subj_total</span>
<span id="cb8-58"><a href="#cb8-58"></a>    group by aesoc, aedecod;</span>
<span id="cb8-59"><a href="#cb8-59"></a>quit;</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>1. サブクエリ（副問い合わせ）：</strong></p>
<div class="sourceCode" id="cb9" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb9-1"><a href="#cb9-1"></a>from (select aesoc, usubjid, arm</span>
<span id="cb9-2"><a href="#cb9-2"></a>      from ae_safety_arm</span>
<span id="cb9-3"><a href="#cb9-3"></a>      group by aesoc, usubjid, arm) as subj_arm</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p><code>()</code> 内のSELECT文が先に実行される</p></li>
<li><p>その結果を<code>subj_arm</code>という名前のテーブルとして使用</p></li>
<li><p><strong>重要な目的</strong>: 同一被験者の同一SOCで複数AEがある場合の重複除去</p></li>
</ul>
<p><strong>2. GROUP BY句：</strong></p>
<div class="sourceCode" id="cb10" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb10-1"><a href="#cb10-1"></a>group by aesoc, usubjid, arm</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>指定した列の組み合わせでデータをグループ化</p></li>
<li><p>各グループに対して集計関数（COUNT, SUMなど）を適用</p></li>
<li><p>例：被験者001の心臓障害は1つのグループとして扱われる</p></li>
</ul>
<p><strong>3. 集計関数：</strong></p>
<div class="sourceCode" id="cb11" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb11-1"><a href="#cb11-1"></a>count(distinct usubjid)  -- ユニークな被験者数をカウント</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>4. 文字列処理：</strong></p>
<div class="sourceCode" id="cb12" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb12-1"><a href="#cb12-1"></a>compress(put(count(distinct usubjid), 8.)) || '(' || </span>
<span id="cb12-2"><a href="#cb12-2"></a>compress(put((count(distinct usubjid)/&amp;total_n)*100, 8.1)) || ')' as c</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p><code>put()</code> - 数値を文字列に変換</p></li>
<li><p><code>compress()</code> - 不要な空白を除去</p></li>
<li><p><code>||</code> - 文字列結合演算子</p></li>
<li><p>結果例：「5(10.0)」形式の文字列作成</p></li>
</ul>
<p><strong>5. OUTER UNION CORRESPONDING：</strong></p>
<div class="sourceCode" id="cb13" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb13-1"><a href="#cb13-1"></a>select ... from ...</span>
<span id="cb13-2"><a href="#cb13-2"></a>union all  </span>
<span id="cb13-3"><a href="#cb13-3"></a>select ... from ...</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>複数のSELECT結果を縦に結合</li>
</ul>
<!-- -->
<ul>
<li><code>all</code> - 重複行も含めて全て結合</li>
</ul>
</section>
<section id="step3-データの転置と整形" class="level3" data-number="1.1.3">
<h3 data-number="1.1.3" class="anchored" data-anchor-id="step3-データの転置と整形"><span class="header-section-number">1.1.3</span> Step3: データの転置と整形</h3>
<div class="sourceCode" id="cb14" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb14-1"><a href="#cb14-1"></a>/* Step 4-1: ソート処理（転置前に必要） */</span>
<span id="cb14-2"><a href="#cb14-2"></a>proc sort data=ae_comprehensive;</span>
<span id="cb14-3"><a href="#cb14-3"></a>    by aesoc aept arm_order arm_group;</span>
<span id="cb14-4"><a href="#cb14-4"></a>run;</span>
<span id="cb14-5"><a href="#cb14-5"></a></span>
<span id="cb14-6"><a href="#cb14-6"></a>/* Step 4-2: 転置処理 */</span>
<span id="cb14-7"><a href="#cb14-7"></a>proc transpose data=ae_comprehensive out=ae_arm_pivot;</span>
<span id="cb14-8"><a href="#cb14-8"></a>    by aesoc aept;</span>
<span id="cb14-9"><a href="#cb14-9"></a>    id arm_group;</span>
<span id="cb14-10"><a href="#cb14-10"></a>    var c;</span>
<span id="cb14-11"><a href="#cb14-11"></a>run;</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>重要なポイント：</strong></p>
<p><strong>1. PROC SORTの必要性：</strong></p>
<ul>
<li><p>PROC TRANSPOSEはBY変数で指定した順序でデータが並んでいることを要求</p></li>
<li><p>事前にソートしないとエラーが発生</p></li>
</ul>
<p><strong>2. PROC TRANSPOSEの解説：</strong></p>
<ul>
<li><p><code>data=ae_comprehensive</code> - 入力データセット</p></li>
<li><p><code>out=ae_arm_pivot</code> - 出力データセット名</p></li>
<li><p><code>by aesoc aept;</code> - グループ化変数（これらの組み合わせごとに転置）</p></li>
<li><p><code>id arm_group;</code> - 新しい列名になる変数（Treatment, Control, Totalが列名になる）</p></li>
<li><p><code>var c;</code> - 転置する値の変数</p></li>
</ul>
<div class="sourceCode" id="cb15" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb15-1"><a href="#cb15-1"></a>転置前:</span>
<span id="cb15-2"><a href="#cb15-2"></a>aesoc    aept  arm_group  c</span>
<span id="cb15-3"><a href="#cb15-3"></a>心臓障害  ""   Treatment  2(6.7)</span>
<span id="cb15-4"><a href="#cb15-4"></a>心臓障害  ""   Control    1(3.3)</span>
<span id="cb15-5"><a href="#cb15-5"></a>心臓障害  ""   Total      3(6.0)</span>
<span id="cb15-6"><a href="#cb15-6"></a></span>
<span id="cb15-7"><a href="#cb15-7"></a>転置後:</span>
<span id="cb15-8"><a href="#cb15-8"></a>aesoc    aept  Treatment  Control  Total</span>
<span id="cb15-9"><a href="#cb15-9"></a>心臓障害  ""   2(6.7)     1(3.3)   3(6.0)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb16" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb16-1"><a href="#cb16-1"></a>//* Step 4-3: 表示用整形 */</span>
<span id="cb16-2"><a href="#cb16-2"></a>data final_display_ordered;</span>
<span id="cb16-3"><a href="#cb16-3"></a>    set ae_arm_pivot;</span>
<span id="cb16-4"><a href="#cb16-4"></a>    </span>
<span id="cb16-5"><a href="#cb16-5"></a>    /* 欠損値処理 */</span>
<span id="cb16-6"><a href="#cb16-6"></a>    if Treatment = "" then Treatment = "0(0.0)";</span>
<span id="cb16-7"><a href="#cb16-7"></a>    if Control = "" then Control = "0(0.0)";</span>
<span id="cb16-8"><a href="#cb16-8"></a>    if Total = "" then Total = "0(0.0)";</span>
<span id="cb16-9"><a href="#cb16-9"></a>    </span>
<span id="cb16-10"><a href="#cb16-10"></a>    /* 階層表示 */</span>
<span id="cb16-11"><a href="#cb16-11"></a>    length display_term $100;</span>
<span id="cb16-12"><a href="#cb16-12"></a>    if aept = "" then display_term = aesoc;</span>
<span id="cb16-13"><a href="#cb16-13"></a>    else display_term = "  " || aept;</span>
<span id="cb16-14"><a href="#cb16-14"></a>    </span>
<span id="cb16-15"><a href="#cb16-15"></a>    /* ソート用変数 */</span>
<span id="cb16-16"><a href="#cb16-16"></a>    if aept = "" then sort_level = 1;  /* SOCレベル */</span>
<span id="cb16-17"><a href="#cb16-17"></a>    else sort_level = 2;               /* PTレベル */</span>
<span id="cb16-18"><a href="#cb16-18"></a>    </span>
<span id="cb16-19"><a href="#cb16-19"></a>    drop _name_;</span>
<span id="cb16-20"><a href="#cb16-20"></a>run;</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>DATA STEPでの後処理解説：</strong></p>
<ul>
<li><p><code>set ae_arm_pivot;</code> - 入力データセットを読み込み</p></li>
<li><p><code>if Y = "" then Y = "0(0.0)";</code> - 空文字列を”0(0.0)“に置換</p></li>
<li><p><code>"  " || aept</code> - PTの前に2つのスペースでインデント追加</p></li>
<li><p><strong>階層表示の仕組み</strong>:</p></li>
</ul>
<pre><code>-    SOCレベル: `display_term = aesoc`（例：「心臓障害」）

-    PTレベル: `display_term = "  " || aept`（例：「 完全房室ブロック」）</code></pre>
</section>
</section>
<section id="修正されたappendixプログラム列順序修正版" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="修正されたappendixプログラム列順序修正版"><span class="header-section-number">1.2</span> 修正されたAppendixプログラム（列順序修正版）</h2>
<div class="sourceCode" id="cb18" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb18-1"><a href="#cb18-1"></a>/*======================================================================================*/</span>
<span id="cb18-2"><a href="#cb18-2"></a>/* プログラム名: 治療群別有害事象集計 (SOC/PT別) - シンプル版                           */</span>
<span id="cb18-3"><a href="#cb18-3"></a>/* 作成者: [作成者名]                                                                   */</span>
<span id="cb18-4"><a href="#cb18-4"></a>/* 作成日: [作成日]                                                                     */</span>
<span id="cb18-5"><a href="#cb18-5"></a>/* 目的: 臨床試験における有害事象データの治療群別集計                                   */</span>
<span id="cb18-6"><a href="#cb18-6"></a>/*      Treatment群、Control群、Total の3つの観点からSOC/PT別に集計                   */</span>
<span id="cb18-7"><a href="#cb18-7"></a>/*======================================================================================*/</span>
<span id="cb18-8"><a href="#cb18-8"></a></span>
<span id="cb18-9"><a href="#cb18-9"></a>/*---------------------------------------------------------------------------------------*/</span>
<span id="cb18-10"><a href="#cb18-10"></a>/* Step 1: ADSLデータセット（被験者レベル）の作成                                       */</span>
<span id="cb18-11"><a href="#cb18-11"></a>/*---------------------------------------------------------------------------------------*/</span>
<span id="cb18-12"><a href="#cb18-12"></a>data adsl;</span>
<span id="cb18-13"><a href="#cb18-13"></a>    length usubjid $20 subjid $10 arm $20 saffl $1;</span>
<span id="cb18-14"><a href="#cb18-14"></a>    </span>
<span id="cb18-15"><a href="#cb18-15"></a>    /* 50名の被験者データを作成 */</span>
<span id="cb18-16"><a href="#cb18-16"></a>    do i = 1 to 50;</span>
<span id="cb18-17"><a href="#cb18-17"></a>        usubjid = cats("STUDY001-", put(i, z3.));</span>
<span id="cb18-18"><a href="#cb18-18"></a>        subjid = put(i, z3.);</span>
<span id="cb18-19"><a href="#cb18-19"></a>        </span>
<span id="cb18-20"><a href="#cb18-20"></a>        /* 治療群の割り当て（2:1でTreatment:Placebo） */</span>
<span id="cb18-21"><a href="#cb18-21"></a>        if mod(i, 3) = 0 then arm = "Placebo";</span>
<span id="cb18-22"><a href="#cb18-22"></a>        else arm = "Treatment";</span>
<span id="cb18-23"><a href="#cb18-23"></a>        </span>
<span id="cb18-24"><a href="#cb18-24"></a>        /* 安全性解析対象フラグ */</span>
<span id="cb18-25"><a href="#cb18-25"></a>        saffl = "Y";</span>
<span id="cb18-26"><a href="#cb18-26"></a>        </span>
<span id="cb18-27"><a href="#cb18-27"></a>        output;</span>
<span id="cb18-28"><a href="#cb18-28"></a>    end;</span>
<span id="cb18-29"><a href="#cb18-29"></a>    drop i;</span>
<span id="cb18-30"><a href="#cb18-30"></a>run;</span>
<span id="cb18-31"><a href="#cb18-31"></a></span>
<span id="cb18-32"><a href="#cb18-32"></a>/*---------------------------------------------------------------------------------------*/</span>
<span id="cb18-33"><a href="#cb18-33"></a>/* Step 2: ADAEデータセット（有害事象レベル）の作成                                     */</span>
<span id="cb18-34"><a href="#cb18-34"></a>/*---------------------------------------------------------------------------------------*/</span>
<span id="cb18-35"><a href="#cb18-35"></a>data adae;</span>
<span id="cb18-36"><a href="#cb18-36"></a>    length usubjid $20 subjid $10 aesoc $50 aedecod $100 aeser $1 aerel $1 aestdy 8;</span>
<span id="cb18-37"><a href="#cb18-37"></a>    </span>
<span id="cb18-38"><a href="#cb18-38"></a>    /* 心臓障害の有害事象 */</span>
<span id="cb18-39"><a href="#cb18-39"></a>    usubjid = "STUDY001-001"; subjid = "001"; aesoc = "心臓障害"; aedecod = "完全房室ブロック"; aeser = "Y"; aerel = "Y"; aestdy = 15; output;</span>
<span id="cb18-40"><a href="#cb18-40"></a>    usubjid = "STUDY001-001"; subjid = "001"; aesoc = "心臓障害"; aedecod = "徐脈"; aeser = "N"; aerel = "Y"; aestdy = 22; output;</span>
<span id="cb18-41"><a href="#cb18-41"></a>    </span>
<span id="cb18-42"><a href="#cb18-42"></a>    usubjid = "STUDY001-002"; subjid = "002"; aesoc = "心臓障害"; aedecod = "心不全慢性"; aeser = "Y"; aerel = "Y"; aestdy = 8; output;</span>
<span id="cb18-43"><a href="#cb18-43"></a>    usubjid = "STUDY001-002"; subjid = "002"; aesoc = "心臓障害"; aedecod = "心不全"; aeser = "N"; aerel = "N"; aestdy = 45; output;</span>
<span id="cb18-44"><a href="#cb18-44"></a>    </span>
<span id="cb18-45"><a href="#cb18-45"></a>    usubjid = "STUDY001-004"; subjid = "004"; aesoc = "心臓障害"; aedecod = "動悸"; aeser = "N"; aerel = "Y"; aestdy = 3; output;</span>
<span id="cb18-46"><a href="#cb18-46"></a>    usubjid = "STUDY001-007"; subjid = "007"; aesoc = "心臓障害"; aedecod = "洞停止"; aeser = "N"; aerel = "N"; aestdy = 34; output;</span>
<span id="cb18-47"><a href="#cb18-47"></a>    usubjid = "STUDY001-010"; subjid = "010"; aesoc = "心臓障害"; aedecod = "完全房室ブロック"; aeser = "Y"; aerel = "Y"; aestdy = 25; output;</span>
<span id="cb18-48"><a href="#cb18-48"></a>    usubjid = "STUDY001-013"; subjid = "013"; aesoc = "心臓障害"; aedecod = "徐脈"; aeser = "N"; aerel = "Y"; aestdy = 11; output;</span>
<span id="cb18-49"><a href="#cb18-49"></a>    usubjid = "STUDY001-016"; subjid = "016"; aesoc = "心臓障害"; aedecod = "心房細動"; aeser = "Y"; aerel = "N"; aestdy = 67; output;</span>
<span id="cb18-50"><a href="#cb18-50"></a>    usubjid = "STUDY001-019"; subjid = "019"; aesoc = "心臓障害"; aedecod = "狭心症"; aeser = "N"; aerel = "Y"; aestdy = 44; output;</span>
<span id="cb18-51"><a href="#cb18-51"></a>    </span>
<span id="cb18-52"><a href="#cb18-52"></a>    /* 胃腸障害の有害事象 */</span>
<span id="cb18-53"><a href="#cb18-53"></a>    usubjid = "STUDY001-005"; subjid = "005"; aesoc = "胃腸障害"; aedecod = "悪心"; aeser = "N"; aerel = "Y"; aestdy = 2; output;</span>
<span id="cb18-54"><a href="#cb18-54"></a>    usubjid = "STUDY001-005"; subjid = "005"; aesoc = "胃腸障害"; aedecod = "嘔吐"; aeser = "N"; aerel = "Y"; aestdy = 5; output;</span>
<span id="cb18-55"><a href="#cb18-55"></a>    usubjid = "STUDY001-008"; subjid = "008"; aesoc = "胃腸障害"; aedecod = "下痢"; aeser = "N"; aerel = "Y"; aestdy = 18; output;</span>
<span id="cb18-56"><a href="#cb18-56"></a>    usubjid = "STUDY001-011"; subjid = "011"; aesoc = "胃腸障害"; aedecod = "便秘"; aeser = "N"; aerel = "N"; aestdy = 28; output;</span>
<span id="cb18-57"><a href="#cb18-57"></a>    usubjid = "STUDY001-014"; subjid = "014"; aesoc = "胃腸障害"; aedecod = "悪心"; aeser = "N"; aerel = "Y"; aestdy = 4; output;</span>
<span id="cb18-58"><a href="#cb18-58"></a>    usubjid = "STUDY001-017"; subjid = "017"; aesoc = "胃腸障害"; aedecod = "腹痛"; aeser = "N"; aerel = "N"; aestdy = 32; output;</span>
<span id="cb18-59"><a href="#cb18-59"></a>    usubjid = "STUDY001-020"; subjid = "020"; aesoc = "胃腸障害"; aedecod = "消化不良"; aeser = "N"; aerel = "Y"; aestdy = 12; output;</span>
<span id="cb18-60"><a href="#cb18-60"></a>    </span>
<span id="cb18-61"><a href="#cb18-61"></a>    /* 神経系障害の有害事象 */</span>
<span id="cb18-62"><a href="#cb18-62"></a>    usubjid = "STUDY001-006"; subjid = "006"; aesoc = "神経系障害"; aedecod = "頭痛"; aeser = "N"; aerel = "Y"; aestdy = 1; output;</span>
<span id="cb18-63"><a href="#cb18-63"></a>    usubjid = "STUDY001-006"; subjid = "006"; aesoc = "神経系障害"; aedecod = "めまい"; aeser = "N"; aerel = "Y"; aestdy = 14; output;</span>
<span id="cb18-64"><a href="#cb18-64"></a>    usubjid = "STUDY001-009"; subjid = "009"; aesoc = "神経系障害"; aedecod = "傾眠"; aeser = "N"; aerel = "Y"; aestdy = 7; output;</span>
<span id="cb18-65"><a href="#cb18-65"></a>    usubjid = "STUDY001-012"; subjid = "012"; aesoc = "神経系障害"; aedecod = "頭痛"; aeser = "N"; aerel = "N"; aestdy = 21; output;</span>
<span id="cb18-66"><a href="#cb18-66"></a>    usubjid = "STUDY001-015"; subjid = "015"; aesoc = "神経系障害"; aedecod = "めまい"; aeser = "N"; aerel = "N"; aestdy = 19; output;</span>
<span id="cb18-67"><a href="#cb18-67"></a>    usubjid = "STUDY001-018"; subjid = "018"; aesoc = "神経系障害"; aedecod = "振戦"; aeser = "N"; aerel = "Y"; aestdy = 29; output;</span>
<span id="cb18-68"><a href="#cb18-68"></a>    </span>
<span id="cb18-69"><a href="#cb18-69"></a>    /* 皮膚および皮下組織障害 */</span>
<span id="cb18-70"><a href="#cb18-70"></a>    usubjid = "STUDY001-021"; subjid = "021"; aesoc = "皮膚および皮下組織障害"; aedecod = "発疹"; aeser = "N"; aerel = "Y"; aestdy = 9; output;</span>
<span id="cb18-71"><a href="#cb18-71"></a>    usubjid = "STUDY001-022"; subjid = "022"; aesoc = "皮膚および皮下組織障害"; aedecod = "そう痒症"; aeser = "N"; aerel = "Y"; aestdy = 16; output;</span>
<span id="cb18-72"><a href="#cb18-72"></a>    usubjid = "STUDY001-023"; subjid = "023"; aesoc = "皮膚および皮下組織障害"; aedecod = "紅斑"; aeser = "N"; aerel = "N"; aestdy = 23; output;</span>
<span id="cb18-73"><a href="#cb18-73"></a>    </span>
<span id="cb18-74"><a href="#cb18-74"></a>    /* 一般・全身障害および投与部位の状態 */</span>
<span id="cb18-75"><a href="#cb18-75"></a>    usubjid = "STUDY001-024"; subjid = "024"; aesoc = "一般・全身障害および投与部位の状態"; aedecod = "疲労"; aeser = "N"; aerel = "Y"; aestdy = 5; output;</span>
<span id="cb18-76"><a href="#cb18-76"></a>    usubjid = "STUDY001-025"; subjid = "025"; aesoc = "一般・全身障害および投与部位の状態"; aedecod = "発熱"; aeser = "N"; aerel = "N"; aestdy = 13; output;</span>
<span id="cb18-77"><a href="#cb18-77"></a>    usubjid = "STUDY001-026"; subjid = "026"; aesoc = "一般・全身障害および投与部位の状態"; aedecod = "無力症"; aeser = "N"; aerel = "Y"; aestdy = 27; output;</span>
<span id="cb18-78"><a href="#cb18-78"></a>run;</span>
<span id="cb18-79"><a href="#cb18-79"></a></span>
<span id="cb18-80"><a href="#cb18-80"></a>/*---------------------------------------------------------------------------------------*/</span>
<span id="cb18-81"><a href="#cb18-81"></a>/* Step 3: 治療群別有害事象集計の実行                                                   */</span>
<span id="cb18-82"><a href="#cb18-82"></a>/*---------------------------------------------------------------------------------------*/</span>
<span id="cb18-83"><a href="#cb18-83"></a></span>
<span id="cb18-84"><a href="#cb18-84"></a>/* Step 3-1: 安全性解析対象データの準備と母集団サイズ取得 */</span>
<span id="cb18-85"><a href="#cb18-85"></a>proc sql;</span>
<span id="cb18-86"><a href="#cb18-86"></a>    /* 安全性解析対象のAEデータ抽出（ARM情報付き） */</span>
<span id="cb18-87"><a href="#cb18-87"></a>    create table ae_safety_arm as</span>
<span id="cb18-88"><a href="#cb18-88"></a>    select a.usubjid, a.aesoc, a.aedecod, a.aerel, a.aeser, </span>
<span id="cb18-89"><a href="#cb18-89"></a>           case when s.arm = "Placebo" then "Control" </span>
<span id="cb18-90"><a href="#cb18-90"></a>                else s.arm end as arm</span>
<span id="cb18-91"><a href="#cb18-91"></a>    from adae a</span>
<span id="cb18-92"><a href="#cb18-92"></a>    inner join adsl s on a.usubjid = s.usubjid and s.saffl = "Y";</span>
<span id="cb18-93"><a href="#cb18-93"></a>    </span>
<span id="cb18-94"><a href="#cb18-94"></a>    /* 各ARM別とTOTALの母集団サイズ取得 */</span>
<span id="cb18-95"><a href="#cb18-95"></a>    select count(*) into :total_n</span>
<span id="cb18-96"><a href="#cb18-96"></a>    from adsl</span>
<span id="cb18-97"><a href="#cb18-97"></a>    where saffl = "Y";</span>
<span id="cb18-98"><a href="#cb18-98"></a>    </span>
<span id="cb18-99"><a href="#cb18-99"></a>    select count(*) into :treatment_n</span>
<span id="cb18-100"><a href="#cb18-100"></a>    from adsl  </span>
<span id="cb18-101"><a href="#cb18-101"></a>    where saffl = "Y" and arm = "Treatment";</span>
<span id="cb18-102"><a href="#cb18-102"></a>    </span>
<span id="cb18-103"><a href="#cb18-103"></a>    select count(*) into :control_n</span>
<span id="cb18-104"><a href="#cb18-104"></a>    from adsl</span>
<span id="cb18-105"><a href="#cb18-105"></a>    where saffl = "Y" and arm = "Placebo";  /* 元データではPlacebo */</span>
<span id="cb18-106"><a href="#cb18-106"></a>quit;</span>
<span id="cb18-107"><a href="#cb18-107"></a></span>
<span id="cb18-108"><a href="#cb18-108"></a>/* Step 3-2: 治療群別SOC/PT集計の実行 */</span>
<span id="cb18-109"><a href="#cb18-109"></a>proc sql;</span>
<span id="cb18-110"><a href="#cb18-110"></a>    create table ae_comprehensive as</span>
<span id="cb18-111"><a href="#cb18-111"></a>    </span>
<span id="cb18-112"><a href="#cb18-112"></a>    /* SOCレベル - ARM別 */</span>
<span id="cb18-113"><a href="#cb18-113"></a>    select aesoc, "" as aept, arm as arm_group,</span>
<span id="cb18-114"><a href="#cb18-114"></a>           compress(put(count(distinct usubjid), 8.)) || '(' || </span>
<span id="cb18-115"><a href="#cb18-115"></a>           compress(put((count(distinct usubjid)/</span>
<span id="cb18-116"><a href="#cb18-116"></a>               case when arm = "Treatment" then &amp;treatment_n</span>
<span id="cb18-117"><a href="#cb18-117"></a>                    when arm = "Control" then &amp;control_n</span>
<span id="cb18-118"><a href="#cb18-118"></a>                    else &amp;total_n end)*100, 8.1)) || ')' as c,</span>
<span id="cb18-119"><a href="#cb18-119"></a>           case when arm = "Treatment" then 1</span>
<span id="cb18-120"><a href="#cb18-120"></a>                when arm = "Control" then 2</span>
<span id="cb18-121"><a href="#cb18-121"></a>                else 3 end as arm_order</span>
<span id="cb18-122"><a href="#cb18-122"></a>    from (select aesoc, usubjid, arm</span>
<span id="cb18-123"><a href="#cb18-123"></a>          from ae_safety_arm</span>
<span id="cb18-124"><a href="#cb18-124"></a>          group by aesoc, usubjid, arm) as subj_arm</span>
<span id="cb18-125"><a href="#cb18-125"></a>    group by aesoc, arm</span>
<span id="cb18-126"><a href="#cb18-126"></a>    </span>
<span id="cb18-127"><a href="#cb18-127"></a>    union all</span>
<span id="cb18-128"><a href="#cb18-128"></a>    </span>
<span id="cb18-129"><a href="#cb18-129"></a>    /* SOCレベル - Total */</span>
<span id="cb18-130"><a href="#cb18-130"></a>    select aesoc, "" as aept, "Total" as arm_group,</span>
<span id="cb18-131"><a href="#cb18-131"></a>           compress(put(count(distinct usubjid), 8.)) || '(' || </span>
<span id="cb18-132"><a href="#cb18-132"></a>           compress(put((count(distinct usubjid)/&amp;total_n)*100, 8.1)) || ')' as c,</span>
<span id="cb18-133"><a href="#cb18-133"></a>           3 as arm_order</span>
<span id="cb18-134"><a href="#cb18-134"></a>    from (select aesoc, usubjid</span>
<span id="cb18-135"><a href="#cb18-135"></a>          from ae_safety_arm</span>
<span id="cb18-136"><a href="#cb18-136"></a>          group by aesoc, usubjid) as subj_total</span>
<span id="cb18-137"><a href="#cb18-137"></a>    group by aesoc</span>
<span id="cb18-138"><a href="#cb18-138"></a>    </span>
<span id="cb18-139"><a href="#cb18-139"></a>    union all</span>
<span id="cb18-140"><a href="#cb18-140"></a>    </span>
<span id="cb18-141"><a href="#cb18-141"></a>    /* PTレベル - ARM別 */</span>
<span id="cb18-142"><a href="#cb18-142"></a>    select aesoc, aedecod as aept, arm as arm_group,</span>
<span id="cb18-143"><a href="#cb18-143"></a>           compress(put(count(distinct usubjid), 8.)) || '(' || </span>
<span id="cb18-144"><a href="#cb18-144"></a>           compress(put((count(distinct usubjid)/</span>
<span id="cb18-145"><a href="#cb18-145"></a>               case when arm = "Treatment" then &amp;treatment_n</span>
<span id="cb18-146"><a href="#cb18-146"></a>                    when arm = "Control" then &amp;control_n</span>
<span id="cb18-147"><a href="#cb18-147"></a>                    else &amp;total_n end)*100, 8.1)) || ')' as c,</span>
<span id="cb18-148"><a href="#cb18-148"></a>           case when arm = "Treatment" then 1</span>
<span id="cb18-149"><a href="#cb18-149"></a>                when arm = "Control" then 2</span>
<span id="cb18-150"><a href="#cb18-150"></a>                else 3 end as arm_order</span>
<span id="cb18-151"><a href="#cb18-151"></a>    from (select aesoc, aedecod, usubjid, arm</span>
<span id="cb18-152"><a href="#cb18-152"></a>          from ae_safety_arm</span>
<span id="cb18-153"><a href="#cb18-153"></a>          group by aesoc, aedecod, usubjid, arm) as subj_arm</span>
<span id="cb18-154"><a href="#cb18-154"></a>    group by aesoc, aedecod, arm</span>
<span id="cb18-155"><a href="#cb18-155"></a>    </span>
<span id="cb18-156"><a href="#cb18-156"></a>    union all</span>
<span id="cb18-157"><a href="#cb18-157"></a>    </span>
<span id="cb18-158"><a href="#cb18-158"></a>    /* PTレベル - Total */</span>
<span id="cb18-159"><a href="#cb18-159"></a>    select aesoc, aedecod as aept, "Total" as arm_group,</span>
<span id="cb18-160"><a href="#cb18-160"></a>           compress(put(count(distinct usubjid), 8.)) || '(' || </span>
<span id="cb18-161"><a href="#cb18-161"></a>           compress(put((count(distinct usubjid)/&amp;total_n)*100, 8.1)) || ')' as c,</span>
<span id="cb18-162"><a href="#cb18-162"></a>           3 as arm_order</span>
<span id="cb18-163"><a href="#cb18-163"></a>    from (select aesoc, aedecod, usubjid</span>
<span id="cb18-164"><a href="#cb18-164"></a>          from ae_safety_arm</span>
<span id="cb18-165"><a href="#cb18-165"></a>          group by aesoc, aedecod, usubjid) as subj_total</span>
<span id="cb18-166"><a href="#cb18-166"></a>    group by aesoc, aedecod;</span>
<span id="cb18-167"><a href="#cb18-167"></a>quit;</span>
<span id="cb18-168"><a href="#cb18-168"></a></span>
<span id="cb18-169"><a href="#cb18-169"></a>/*---------------------------------------------------------------------------------------*/</span>
<span id="cb18-170"><a href="#cb18-170"></a>/* Step 4: データの転置と整形                                                           */</span>
<span id="cb18-171"><a href="#cb18-171"></a>/*---------------------------------------------------------------------------------------*/</span>
<span id="cb18-172"><a href="#cb18-172"></a></span>
<span id="cb18-173"><a href="#cb18-173"></a>/* Step 4-1: ソート処理（転置前に必要） */</span>
<span id="cb18-174"><a href="#cb18-174"></a>proc sort data=ae_comprehensive;</span>
<span id="cb18-175"><a href="#cb18-175"></a>    by aesoc aept arm_order arm_group;</span>
<span id="cb18-176"><a href="#cb18-176"></a>run;</span>
<span id="cb18-177"><a href="#cb18-177"></a></span>
<span id="cb18-178"><a href="#cb18-178"></a>/* Step 4-2: 転置処理 */</span>
<span id="cb18-179"><a href="#cb18-179"></a>proc transpose data=ae_comprehensive out=ae_arm_pivot;</span>
<span id="cb18-180"><a href="#cb18-180"></a>    by aesoc aept;</span>
<span id="cb18-181"><a href="#cb18-181"></a>    id arm_group;</span>
<span id="cb18-182"><a href="#cb18-182"></a>    var c;</span>
<span id="cb18-183"><a href="#cb18-183"></a>run;</span>
<span id="cb18-184"><a href="#cb18-184"></a></span>
<span id="cb18-185"><a href="#cb18-185"></a>/* Step 4-3: 表示用整形 */</span>
<span id="cb18-186"><a href="#cb18-186"></a>data final_display_ordered;</span>
<span id="cb18-187"><a href="#cb18-187"></a>    retain display_term Treatment Control Total;  /* 列順序の明示的制御 */</span>
<span id="cb18-188"><a href="#cb18-188"></a>    set ae_arm_pivot;</span>
<span id="cb18-189"><a href="#cb18-189"></a>    </span>
<span id="cb18-190"><a href="#cb18-190"></a>    /* 欠損値処理 */</span>
<span id="cb18-191"><a href="#cb18-191"></a>    if Treatment = "" then Treatment = "0(0.0)";</span>
<span id="cb18-192"><a href="#cb18-192"></a>    if Control = "" then Control = "0(0.0)";</span>
<span id="cb18-193"><a href="#cb18-193"></a>    if Total = "" then Total = "0(0.0)";</span>
<span id="cb18-194"><a href="#cb18-194"></a>    </span>
<span id="cb18-195"><a href="#cb18-195"></a>    /* 階層表示 */</span>
<span id="cb18-196"><a href="#cb18-196"></a>    length display_term $100;</span>
<span id="cb18-197"><a href="#cb18-197"></a>    if aept = "" then display_term = aesoc;</span>
<span id="cb18-198"><a href="#cb18-198"></a>    else display_term = "  " || aept;</span>
<span id="cb18-199"><a href="#cb18-199"></a>    </span>
<span id="cb18-200"><a href="#cb18-200"></a>    /* ソート用変数 */</span>
<span id="cb18-201"><a href="#cb18-201"></a>    if aept = "" then sort_level = 1;  /* SOCレベル */</span>
<span id="cb18-202"><a href="#cb18-202"></a>    else sort_level = 2;               /* PTレベル */</span>
<span id="cb18-203"><a href="#cb18-203"></a>    </span>
<span id="cb18-204"><a href="#cb18-204"></a>    drop _name_;</span>
<span id="cb18-205"><a href="#cb18-205"></a>run;</span>
<span id="cb18-206"><a href="#cb18-206"></a></span>
<span id="cb18-207"><a href="#cb18-207"></a>/* Step 4-4: 最終ソート */</span>
<span id="cb18-208"><a href="#cb18-208"></a>proc sort data=final_display_ordered;</span>
<span id="cb18-209"><a href="#cb18-209"></a>    by aesoc sort_level aept;</span>
<span id="cb18-210"><a href="#cb18-210"></a>run;</span>
<span id="cb18-211"><a href="#cb18-211"></a></span>
<span id="cb18-212"><a href="#cb18-212"></a>/*---------------------------------------------------------------------------------------*/</span>
<span id="cb18-213"><a href="#cb18-213"></a>/* Step 5: 結果表示                                                                     */</span>
<span id="cb18-214"><a href="#cb18-214"></a>/*---------------------------------------------------------------------------------------*/</span>
<span id="cb18-215"><a href="#cb18-215"></a></span>
<span id="cb18-216"><a href="#cb18-216"></a>/* Step 5-1: 最終結果の表示 */</span>
<span id="cb18-217"><a href="#cb18-217"></a>proc print data=final_display_ordered noobs;</span>
<span id="cb18-218"><a href="#cb18-218"></a>    title1 "有害事象集計表（治療群別）";</span>
<span id="cb18-219"><a href="#cb18-219"></a>    title3 "被験者数 (%)";</span>
<span id="cb18-220"><a href="#cb18-220"></a>run;</span>
<span id="cb18-221"><a href="#cb18-221"></a></span>
<span id="cb18-222"><a href="#cb18-222"></a>/*---------------------------------------------------------------------------------------*/</span>
<span id="cb18-223"><a href="#cb18-223"></a>/* Step 6: 検証用出力                                                                   */</span>
<span id="cb18-224"><a href="#cb18-224"></a>/*---------------------------------------------------------------------------------------*/</span>
<span id="cb18-225"><a href="#cb18-225"></a></span>
<span id="cb18-226"><a href="#cb18-226"></a>/* Step 6-1: 基本統計の確認 */</span>
<span id="cb18-227"><a href="#cb18-227"></a>proc sql;</span>
<span id="cb18-228"><a href="#cb18-228"></a>    title "データ整合性チェック";</span>
<span id="cb18-229"><a href="#cb18-229"></a>    select "元AE総件数" as check_point, </span>
<span id="cb18-230"><a href="#cb18-230"></a>           count(*) as count_value</span>
<span id="cb18-231"><a href="#cb18-231"></a>    from adae</span>
<span id="cb18-232"><a href="#cb18-232"></a>    </span>
<span id="cb18-233"><a href="#cb18-233"></a>    union all</span>
<span id="cb18-234"><a href="#cb18-234"></a>    </span>
<span id="cb18-235"><a href="#cb18-235"></a>    select "安全性解析対象AE件数" as check_point,</span>
<span id="cb18-236"><a href="#cb18-236"></a>           count(*) as count_value</span>
<span id="cb18-237"><a href="#cb18-237"></a>    from ae_safety_arm</span>
<span id="cb18-238"><a href="#cb18-238"></a>    </span>
<span id="cb18-239"><a href="#cb18-239"></a>    union all</span>
<span id="cb18-240"><a href="#cb18-240"></a>    </span>
<span id="cb18-241"><a href="#cb18-241"></a>    select "Treatment群被験者数" as check_point,</span>
<span id="cb18-242"><a href="#cb18-242"></a>           &amp;treatment_n as count_value from (select 1 as dummy)</span>
<span id="cb18-243"><a href="#cb18-243"></a>           </span>
<span id="cb18-244"><a href="#cb18-244"></a>    union all</span>
<span id="cb18-245"><a href="#cb18-245"></a>    </span>
<span id="cb18-246"><a href="#cb18-246"></a>    select "Control群被験者数" as check_point,</span>
<span id="cb18-247"><a href="#cb18-247"></a>           &amp;control_n as count_value from (select 1 as dummy)</span>
<span id="cb18-248"><a href="#cb18-248"></a>           </span>
<span id="cb18-249"><a href="#cb18-249"></a>    union all</span>
<span id="cb18-250"><a href="#cb18-250"></a>    </span>
<span id="cb18-251"><a href="#cb18-251"></a>    select "Total被験者数" as check_point,</span>
<span id="cb18-252"><a href="#cb18-252"></a>           &amp;total_n as count_value from (select 1 as dummy);</span>
<span id="cb18-253"><a href="#cb18-253"></a>quit;</span>
<span id="cb18-254"><a href="#cb18-254"></a></span>
<span id="cb18-255"><a href="#cb18-255"></a>/* Step 6-2: SOC別詳細検証 */</span>
<span id="cb18-256"><a href="#cb18-256"></a>proc sql;</span>
<span id="cb18-257"><a href="#cb18-257"></a>   title "SOC別被験者数検証";</span>
<span id="cb18-258"><a href="#cb18-258"></a>   select aesoc,</span>
<span id="cb18-259"><a href="#cb18-259"></a>          count(distinct case when arm = "Treatment" then usubjid else null end) as treatment_subj,</span>
<span id="cb18-260"><a href="#cb18-260"></a>          count(distinct case when arm = "Control" then usubjid else null end) as control_subj,</span>
<span id="cb18-261"><a href="#cb18-261"></a>          count(distinct usubjid) as total_subj</span>
<span id="cb18-262"><a href="#cb18-262"></a>   from ae_safety_arm</span>
<span id="cb18-263"><a href="#cb18-263"></a>   group by aesoc</span>
<span id="cb18-264"><a href="#cb18-264"></a>   order by total_subj desc;</span>
<span id="cb18-265"><a href="#cb18-265"></a>quit;</span>
<span id="cb18-266"><a href="#cb18-266"></a></span>
<span id="cb18-267"><a href="#cb18-267"></a>/* Step 6-3: 治療群配分の確認 */</span>
<span id="cb18-268"><a href="#cb18-268"></a>proc freq data=adsl;</span>
<span id="cb18-269"><a href="#cb18-269"></a>   tables arm / nocum;</span>
<span id="cb18-270"><a href="#cb18-270"></a>   title "治療群配分";</span>
<span id="cb18-271"><a href="#cb18-271"></a>run;</span>
<span id="cb18-272"><a href="#cb18-272"></a></span>
<span id="cb18-273"><a href="#cb18-273"></a></span>
<span id="cb18-274"><a href="#cb18-274"></a></span>
<span id="cb18-275"><a href="#cb18-275"></a>/*---------------------------------------------------------------------------------------*/</span>
<span id="cb18-276"><a href="#cb18-276"></a>/* プログラム終了                                                                       */</span>
<span id="cb18-277"><a href="#cb18-277"></a>/*---------------------------------------------------------------------------------------*/</span>
<span id="cb18-278"><a href="#cb18-278"></a></span>
<span id="cb18-279"><a href="#cb18-279"></a>/* タイトルクリア */</span>
<span id="cb18-280"><a href="#cb18-280"></a>title;</span>
<span id="cb18-281"><a href="#cb18-281"></a></span>
<span id="cb18-282"><a href="#cb18-282"></a>/* マクロ変数の確認（ログ出力） */</span>
<span id="cb18-283"><a href="#cb18-283"></a>%put NOTE: Treatment群被験者数 = &amp;treatment_n;</span>
<span id="cb18-284"><a href="#cb18-284"></a>%put NOTE: Control群被験者数 = &amp;control_n;</span>
<span id="cb18-285"><a href="#cb18-285"></a>%put NOTE: Total被験者数 = &amp;total_n;</span>
<span id="cb18-286"><a href="#cb18-286"></a></span>
<span id="cb18-287"><a href="#cb18-287"></a>%put NOTE: 治療群別有害事象集計プログラム実行完了;</span>
<span id="cb18-288"><a href="#cb18-288"></a></span>
<span id="cb18-289"><a href="#cb18-289"></a>/*======================================================================================*/</span>
<span id="cb18-290"><a href="#cb18-290"></a>/* プログラム終了                                                                       */</span>
<span id="cb18-291"><a href="#cb18-291"></a>/* 出力データセット:                                                                    */</span>
<span id="cb18-292"><a href="#cb18-292"></a>/*   - final_display_ordered: 最終的な治療群別集計表                                   */</span>
<span id="cb18-293"><a href="#cb18-293"></a>/*   - ae_safety_arm: 安全性解析対象AEデータ                                           */</span>
<span id="cb18-294"><a href="#cb18-294"></a>/*   - ae_comprehensive: 中間集計データ                                                */</span>
<span id="cb18-295"><a href="#cb18-295"></a>/*======================================================================================*/</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="結果の検証とデバッグ" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="結果の検証とデバッグ"><span class="header-section-number">1.3</span> 結果の検証とデバッグ</h2>
<div class="sourceCode" id="cb19" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb19-1"><a href="#cb19-1"></a>/* 集計結果の検証 */</span>
<span id="cb19-2"><a href="#cb19-2"></a>proc sql;</span>
<span id="cb19-3"><a href="#cb19-3"></a>    /* 元データとの整合性チェック */</span>
<span id="cb19-4"><a href="#cb19-4"></a>    select "元AE総件数" as check_point, </span>
<span id="cb19-5"><a href="#cb19-5"></a>           count(*) as count_value</span>
<span id="cb19-6"><a href="#cb19-6"></a>    from adae</span>
<span id="cb19-7"><a href="#cb19-7"></a>    </span>
<span id="cb19-8"><a href="#cb19-8"></a>    union all</span>
<span id="cb19-9"><a href="#cb19-9"></a>    </span>
<span id="cb19-10"><a href="#cb19-10"></a>    select "安全性解析対象AE件数" as check_point,</span>
<span id="cb19-11"><a href="#cb19-11"></a>           count(*) as count_value</span>
<span id="cb19-12"><a href="#cb19-12"></a>    from ae_safety_arm</span>
<span id="cb19-13"><a href="#cb19-13"></a>    </span>
<span id="cb19-14"><a href="#cb19-14"></a>    union all</span>
<span id="cb19-15"><a href="#cb19-15"></a>    </span>
<span id="cb19-16"><a href="#cb19-16"></a>    select "Treatment群被験者数" as check_point,</span>
<span id="cb19-17"><a href="#cb19-17"></a>           &amp;treatment_n as count_value</span>
<span id="cb19-18"><a href="#cb19-18"></a>           </span>
<span id="cb19-19"><a href="#cb19-19"></a>    union all</span>
<span id="cb19-20"><a href="#cb19-20"></a>    </span>
<span id="cb19-21"><a href="#cb19-21"></a>    select "Control群被験者数" as check_point,</span>
<span id="cb19-22"><a href="#cb19-22"></a>           &amp;control_n as count_value</span>
<span id="cb19-23"><a href="#cb19-23"></a>           </span>
<span id="cb19-24"><a href="#cb19-24"></a>    union all</span>
<span id="cb19-25"><a href="#cb19-25"></a>    </span>
<span id="cb19-26"><a href="#cb19-26"></a>    select "Total被験者数" as check_point,</span>
<span id="cb19-27"><a href="#cb19-27"></a>           &amp;total_n as count_value;</span>
<span id="cb19-28"><a href="#cb19-28"></a>quit;</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>検証SQLの解説：</strong></p>
<ul>
<li><p><code>union all</code> - 複数のSELECT結果を縦に結合（重複も含める）</p></li>
<li><p><code>&amp;treatment_n</code> - 事前に計算したマクロ変数の値を表示</p></li>
<li><p><strong>検証の重要性</strong>: 各ステップで期待する件数が得られているか確認</p></li>
</ul>
<div class="sourceCode" id="cb20" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb20-1"><a href="#cb20-1"></a>/* SOC別被験者数の詳細検証 */</span>
<span id="cb20-2"><a href="#cb20-2"></a>proc sql;</span>
<span id="cb20-3"><a href="#cb20-3"></a>    select aesoc,</span>
<span id="cb20-4"><a href="#cb20-4"></a>           count(distinct case when arm = "Treatment" then usubjid end) as treatment_subj,</span>
<span id="cb20-5"><a href="#cb20-5"></a>           count(distinct case when arm = "Control" then usubjid end) as control_subj,</span>
<span id="cb20-6"><a href="#cb20-6"></a>           count(distinct usubjid) as total_subj</span>
<span id="cb20-7"><a href="#cb20-7"></a>    from ae_safety_arm</span>
<span id="cb20-8"><a href="#cb20-8"></a>    where aerel = "Y"  /* 因果関係ありのみ */</span>
<span id="cb20-9"><a href="#cb20-9"></a>    group by aesoc</span>
<span id="cb20-10"><a href="#cb20-10"></a>    order by total_subj desc;</span>
<span id="cb20-11"><a href="#cb20-11"></a>quit;</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>CASE文の高度な使用：</strong></p>
<div class="sourceCode" id="cb21" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb21-1"><a href="#cb21-1"></a>count(distinct case when arm = "Treatment" then usubjid end)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p><code>case when ... then ... end</code> - 条件を満たす場合のみ値を返す</p></li>
<li><p>Treatment群の場合のみusubjidをカウント対象にする</p></li>
<li><p>1つのクエリで治療群別の集計が可能</p></li>
</ul>
</section>
<section id="初心者向けsql学習のポイント" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="初心者向けsql学習のポイント"><span class="header-section-number">1.4</span> 初心者向けSQL学習のポイント</h2>
<section id="sqlの基本構文理解" class="level3" data-number="1.4.1">
<h3 data-number="1.4.1" class="anchored" data-anchor-id="sqlの基本構文理解"><span class="header-section-number">1.4.1</span> 1. SQLの基本構文理解</h3>
<div class="sourceCode" id="cb22" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb22-1"><a href="#cb22-1"></a>SELECT 何を選ぶか</span>
<span id="cb22-2"><a href="#cb22-2"></a>FROM どのテーブルから  </span>
<span id="cb22-3"><a href="#cb22-3"></a>WHERE どんな条件で</span>
<span id="cb22-4"><a href="#cb22-4"></a>GROUP BY どうグループ化するか</span>
<span id="cb22-5"><a href="#cb22-5"></a>ORDER BY どう並び替えるか</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="joinの理解" class="level3" data-number="1.4.2">
<h3 data-number="1.4.2" class="anchored" data-anchor-id="joinの理解"><span class="header-section-number">1.4.2</span> 2. JOINの理解</h3>
<div class="sourceCode" id="cb23" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb23-1"><a href="#cb23-1"></a>/* 内部結合の例 */</span>
<span id="cb23-2"><a href="#cb23-2"></a>from adae a                    -- メインテーブル</span>
<span id="cb23-3"><a href="#cb23-3"></a>inner join adsl s              -- 結合するテーブル  </span>
<span id="cb23-4"><a href="#cb23-4"></a>on a.usubjid = s.usubjid       -- 結合条件</span>
<span id="cb23-5"><a href="#cb23-5"></a>and s.saffl = "Y"              -- 追加フィルタ</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="集計関数の使い分け" class="level3" data-number="1.4.3">
<h3 data-number="1.4.3" class="anchored" data-anchor-id="集計関数の使い分け"><span class="header-section-number">1.4.3</span> 3. 集計関数の使い分け</h3>
<ul>
<li><p><code>count(*)</code> - 全行数</p></li>
<li><p><code>count(distinct 列名)</code> - ユニークな値の数</p></li>
<li><p><code>sum()</code> - 合計</p></li>
<li><p><code>min()</code>, <code>max()</code> - 最小値、最大値</p></li>
</ul>
</section>
<section id="サブクエリの読み方" class="level3" data-number="1.4.4">
<h3 data-number="1.4.4" class="anchored" data-anchor-id="サブクエリの読み方"><span class="header-section-number">1.4.4</span> 4. サブクエリの読み方</h3>
<div class="sourceCode" id="cb24" data-eval="FALSE," data-code-overflow="wrap"><pre class="sourceCode numberSource sas number-lines code-with-copy"><code class="sourceCode"><span id="cb24-1"><a href="#cb24-1"></a>from (select ... from ... group by ...) as 別名</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>内側のクエリから読む</p></li>
<li><p>外側のクエリは内側の結果を使用</p></li>
</ul>
</section>
</section>
<section id="まとめ" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="まとめ"><span class="header-section-number">1.5</span> まとめ</h2>
<p>本記事では、臨床試験における有害事象データの治療群別集計を、PROC SQLを用いて段階的に実装しました。初心者の方にとって重要なポイントは：</p>
<section id="実践のコツ" class="level3" data-number="1.5.1">
<h3 data-number="1.5.1" class="anchored" data-anchor-id="実践のコツ"><span class="header-section-number">1.5.1</span> 実践のコツ</h3>
<ol type="1">
<li><p><strong>小さく始める</strong>: 複雑なクエリは段階的に構築</p></li>
<li><p><strong>中間結果確認</strong>: 各ステップで<code>PROC PRINT</code>で結果確認</p></li>
<li><p><strong>エラー対処</strong>: エラーメッセージから問題箇所を特定</p></li>
<li><p><strong>コメント活用</strong>: 処理の目的を明記</p></li>
</ol>
<p>この段階的アプローチにより、初心者でも確実に治療群別有害事象集計をマスターできます。重要なのは、各ステップの目的を理解しながら進めることです。</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "コピーしました");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "コピーしました");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            trigger: 'click',
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            positionFixed: true,
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://github.com/kkts1010/kkts1010.github.io/">
<p>Kota Sakamoto</p>
</a>
  </li>  
</ul>
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/kkts1010/kkts1010.github.io/">
<p>Kota Sakamoto</p>
</a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/kkt_1010">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>