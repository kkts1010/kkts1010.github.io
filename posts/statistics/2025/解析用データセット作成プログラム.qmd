---
title: "解析用データセット作成プログラム"
author: "坂本航太"
categories: [SAS,R,解析用データセット]
date-modified: "2025-06-14"
abstract-title: Abstract
abstract: "個人的な解析データセット作成方法をまとめます。"
date: "2025-06-14"
format:
  html: 
    fontsize: normal
    page-layout: full
    lang: "ja"
    encoding: "UTF-8"
    toc: true
    toc-depth: 2
    code-fold: show
    html-math-method: katex
    fig-format: svg
    fig-height: 5
    fig-width: 9
    self-contained: true
    number-sections: true
    code-block-border-left: true
    code-line-numbers: false
    code-overflow: wrap
    highlight-style: atom-one
    df-print: tibble
#   pdf:
#     documentclass: bxjsarticle
#     classoption: 
#       - xelatex
#       - ja=standard
#     pdf-engine: xelatex
#     mainfont: "Times New Roman"
#     sansfont: "Times New Roman"
#     monofont: "Courier New"
#     CJKmainfont: "MS Mincho"  
#     CJKsansfont: "MS Gothic" 
#     toc: true
#     toc-depth: 2
#     number-sections: true
#     colorlinks: true
#     keep-tex: true
editor: visual
---

# 解析用データセット仕様書の作成ガイド

## はじめに

臨床試験や統計解析プロジェクトにおいて、解析用データセット仕様書は分析の設計図とも言える重要な文書です。本記事では、実用的な解析用データセット仕様書の構成と記載内容について、主要な3つのデータセット（ADSL、ADLB、ADTTE）を例に解説し、さらに仕様書に基づくデータセット作成とバリデーションプロセスについても説明します。

## 仕様書の基本構成

解析用データセット仕様書は、主に以下の要素で構成されます：

- **表紙・改訂履歴**：文書管理情報
- **Dataset Definition**：データセットの基本定義
- **Specification**：変数の詳細仕様
- **ADxx_Conversion**：パラメータ変換表（ADLB、ADTTE用）
- **Codelist**：コード値の定義

これらの情報をExcelファイルの複数シートに整理することで、管理しやすく実用的な仕様書が作成できます。

## Specificationシートの構成

変数仕様を記載するSpecificationシートでは、以下の項目を含めることを推奨します：

### 基本項目
- **Varnum**：変数番号（並び順）
- **Domain**：データセット名（ADSL、ADLB、ADTTE等）
- **Variable Name**：変数名
- **Variable Label**：変数ラベル
- **Type**：データタイプ（Char/Num）
- **Length**：変数長
- **Display Format**：表示フォーマット
- **Codelist**：コードリスト参照名
- **Core**：必須度（Req=必須、Perm=任意、Cond=条件付き）
- **Definition**：定義・導出方法

### Specificationシート例

| Varnum | Domain | Variable Name | Variable Label | Type | Length | Display Format | Codelist | Core | Definition |
|--------|--------|---------------|----------------|------|--------|----------------|----------|------|------------|
| 1 | ADSL | STUDYID | Study Identifier | Char | 12 | | | Req | DM.STUDYID |
| 2 | ADSL | USUBJID | Unique Subject Identifier | Char | 40 | | | Req | DM.USUBJID |
| 3 | ADSL | SUBJID | Subject Identifier | Char | 20 | | | Req | DM.SUBJID |
| 4 | ADSL | AGE | Age | Num | 8 | | | Req | DM.AGE |
| 5 | ADSL | SEX | Sex | Char | 1 | | SEX | Req | DM.SEX |
| 6 | ADSL | TRT01P | Planned Treatment for Period 1 | Char | 200 | | | Req | ARM |
| 7 | ADSL | TRT01A | Actual Treatment for Period 1 | Char | 200 | | | Req | ACTARM |
| 8 | ADSL | TRT01PN | Planned Treatment for Period 1 (N) | Num | 8 | | | Req | Derived from TRT01P |
| 9 | ADSL | TRT01AN | Actual Treatment for Period 1 (N) | Num | 8 | | | Req | Derived from TRT01A |
| 10 | ADSL | FASFL | Full Analysis Set Flag | Char | 1 | | NYFL | Req | External derivation |

## ADxx_Conversionシート

ADLB、ADTTEなどのBDS形式データセットでは、パラメータの変換情報を管理するための専用シートを作成します。

### ADLB_Conversionシート例

| PARAM | PARAMCD | PARAMN | AVAL |
|-------|---------|---------|------|
| HbA1c(%) | HBA1C | 1 | input(LABデータ) |
| Blood glucose (mg/dL) | GLU | 2 | input(LABデータ) |
| BUN (mg/dL) | BUN | 3 | input(LABデータ) |
| Creatinine (mg/dL) | CREAT | 4 | input(LABデータ) |
| ALT (U/L) | ALT | 5 | input(LABデータ) |

### ADTTE_Conversionシート例

| PARAM | PARAMCD | PARAMN | AVAL |
|-------|---------|---------|------|
| Overall Survival | OS | 1 | ADT - STARTDT + 1 |
| Progression Free Survival | PFS | 2 | ADT - STARTDT + 1 |
| Time to Progression | TTP | 3 | ADT - STARTDT + 1 |
| Disease Free Survival | DFS | 4 | ADT - STARTDT + 1 |

## ADTTEデータセットの詳細

### ADTTEの特徴
ADTTEは生存時間解析用のデータセットで、以下の特徴があります：

- **1被験者1パラメータにつき1レコード**の構造
- **事象の発生時間**または**打ち切り時間**を記録
- **複数の解析エンドポイント**を1つのデータセットで管理

### ADTTE作成時の重要な考慮事項

#### 1. 事象の優先順位
複数の事象や打ち切りが同日に発生した場合の優先順位を明確に定義する必要があります。例：
- 「10%を超える体重減少」（最優先）
- 「5 cmを超える腹囲減少」
- 完了または中止

#### 2. AVALの計算方法
AVALは通常、以下の式で計算されます：

ここで：
- **STARTDT**：解析開始日（通常は治療開始日：ADSL.TRTSDT）
- **ADT**：解析日（事象発生日または打ち切り日）
- **+1**：0日目を避けるための調整

#### 3. 事象データの取得元
- **事象発生**：ADVS.ADTから日付を取得
- **打ち切り**：ADSL.EOSDTから日付を取得

#### 4. CNSRフラグの設定
- **CNSR=0**：事象発生
- **CNSR=1**：打ち切り

#### 5. ソースデータの追跡（SRCDOM, SRCVAR, SRCSEQ）
ADTTEでは元データの追跡可能性が重要です：

**事象採用時**：
- SRCDOM="ADVS"
- SRCVAR="ADT" 
- SRCSEQ=ADVS.ASEQ

**打ち切り時**：
- SRCDOM="ADSL"
- SRCVAR="EOSDT"
- SRCSEQ=（ブランク）

### ADTTEプログラミングのポイント

1. **データセットの組み合わせ**：複数のデータセット（ADSL、ADVS等）を適切に結合
2. **日付の妥当性チェック**：論理的に矛盾する日付の検出と処理
3. **追跡可能性の確保**：各レコードの導出元を明確に記録
4. **複数事象の処理**：同一被験者で複数の解析パラメータを生成

## Code Listシート

コード値とその意味を定義するシートです。ADaM Terminology形式で管理します。

### Code Listシート構成

| Reference Name | Code Value | Code Text |
|----------------|------------|-----------|
| SEXN | 1 | 男性 |
| SEXN | 2 | 女性 |
| SEX | M | Male |
| SEX | F | Female |
| NYFL | Y | Yes |
| NYFL | N | No |
| AGEU | YEARS | Years |
| AGEU | MONTHS | Months |

## データセット作成プロセス

### 1. 仕様書に基づくプログラム作成
解析用データセット仕様書を読み込み、Specificationシートの定義に従ってSASプログラムを作成します。ADxx_Conversionシートを参照してパラメータ変換処理も実装します。

### 2. ADTTEプログラム例

```sas
/* ADTTE作成例 */
data adtte;
    set adsl;
    
    /* Overall Survival パラメータ */
    param = "Overall Survival";
    paramcd = "OS";
    paramn = 1;
    
    /* 解析開始日 */
    startdt = trtsdt;
    
    /* 事象または打ち切りの判定 */
    if dthfl = "Y" then do;
        adt = dthdt;
        cnsr = 0;
        srcdom = "ADSL";
        srcvar = "DTHDT";
    end;
    else do;
        adt = eosdt;
        cnsr = 1;
        srcdom = "ADSL";
        srcvar = "EOSDT";
    end;
    
    /* AVAL計算 */
    aval = adt - startdt + 1;
    
    /* ラベル付与 */
    label param = "Parameter"
          paramcd = "Parameter Code"
          aval = "Analysis Value";
run;
```